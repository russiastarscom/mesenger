<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover, height=device-height">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#6c5ce7">
    <meta name="format-detection" content="telephone=no">
    <title>Twin</title>
    <style>
        :root {
            --primary-color: #6c5ce7;
            --primary-dark: #5a4fcf;
            --danger-color: #e74c3c;
            --danger-dark: #c0392b;
            --success-color: #2ecc71;
            --success-dark: #27ae60;
            --text-color: #2d3436;
            --text-light: #636e72;
            --bg-color: #f8f9fa;
            --border-color: #e9ecef;
            --sent-message: #6c5ce7;
            --received-message: #ffffff;
            --message-hover: #f5f5f5;
            --modal-bg: #ffffff;
            --input-bg: #ffffff;
            --sidebar-bg: #f8f9fa;
            --header-bg: #ffffff;
            --online-color: #2ecc71;
            --offline-color: #e74c3c;
            --notification-bg: #6c5ce7;
            --notification-text: #ffffff;
            --channel-bg: #f0f3ff;
            --channel-hover: #e1e6ff;
        }
        
        /* –¢–µ–º–Ω–∞—è —Ç–µ–º–∞ */
        body.dark-theme {
            --bg-color: #1e1e1e;
            --text-color: #f0f0f0;
            --text-light: #b0b0b0;
            --border-color: #444444;
            --sent-message: #5a4fcf;
            --received-message: #2d2d2d;
            --message-hover: #333333;
            --modal-bg: #2d2d2d;
            --input-bg: #2d2d2d;
            --sidebar-bg: #1e1e1e;
            --header-bg: #2d2d2d;
            --notification-bg: #5a4fcf;
            --notification-text: #f0f0f0;
            --channel-bg: #2a2a4a;
            --channel-hover: #3a3a5a;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
        }
        
        html, body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            height: 100%;
            width: 100%;
            color: var(--text-color);
            transition: background-color 0.3s, color 0.3s;
            overflow: hidden;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            text-rendering: optimizeLegibility;
        }
        
        .container {
            width: 100%;
            height: 100%;
            background: var(--bg-color);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            transition: background-color 0.3s;
            -webkit-overflow-scrolling: touch;
        }
        
        .mobile-header {
            display: none;
            padding: 12px 15px;
            background: var(--primary-color);
            color: white;
            align-items: center;
            justify-content: space-between;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .mobile-header h1 {
            font-size: 1.2rem;
            font-weight: 500;
        }
        
        .mobile-menu-btn {
            background: none;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 5px;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
        }
        
        .content-wrapper {
            display: flex;
            flex: 1;
            overflow: hidden;
            position: relative;
        }
        
        .sidebar {
            width: 280px;
            background: var(--sidebar-bg);
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease;
            will-change: transform;
            -webkit-overflow-scrolling: touch;
            overflow-y: auto;
        }
        
        .user-profile {
            padding: 15px;
            background: var(--primary-color);
            color: white;
            text-align: center;
            position: sticky;
            top: 0;
            z-index: 10;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .user-profile h2 {
            margin-bottom: 5px;
            font-size: 1.2rem;
            font-weight: 500;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .user-emoji {
            font-size: 1.5rem;
            margin-right: 5px;
        }
        
        .user-profile p {
            font-size: 0.8rem;
            opacity: 0.9;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .connection-status {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-left: 5px;
            background-color: var(--online-color);
        }
        
        .connection-status.offline {
            background-color: var(--offline-color);
        }
        
        .tabs {
            display: flex;
            border-bottom: 1px solid var(--border-color);
            position: sticky;
            top: 0;
            z-index: 10;
            background: var(--sidebar-bg);
        }
        
        .tab {
            flex: 1;
            padding: 12px 0;
            text-align: center;
            cursor: pointer;
            background: transparent;
            border: none;
            font-size: 0.9rem;
            color: var(--text-light);
            transition: all 0.2s;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
            position: relative;
        }
        
        .tab.active {
            color: var(--primary-color);
            border-bottom: 2px solid var(--primary-color);
        }
        
        .search-container {
            padding: 10px;
            border-bottom: 1px solid var(--border-color);
            position: sticky;
            top: 0;
            z-index: 10;
            background: var(--sidebar-bg);
        }
        
        .search-box {
            width: 100%;
            padding: 10px 15px;
            border: 1px solid var(--border-color);
            border-radius: 20px;
            font-size: 0.9rem;
            outline: none;
            background: var(--input-bg);
            color: var(--text-color);
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
        }
        
        .search-results {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            -webkit-overflow-scrolling: touch;
        }
        
        .user-item {
            padding: 12px 15px;
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
            transition: background 0.2s;
            display: flex;
            align-items: center;
            position: relative;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
        }
        
        .user-item:active {
            background: var(--message-hover);
        }
        
        .user-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: var(--primary-color);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 12px;
            font-weight: bold;
            flex-shrink: 0;
        }
        
        .user-info {
            overflow: hidden;
            flex: 1;
        }
        
        .user-info h3 {
            font-size: 0.95rem;
            margin-bottom: 3px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            display: flex;
            align-items: center;
        }
        
        .user-emoji-small {
            font-size: 1rem;
            margin-right: 5px;
        }
        
        .user-info p {
            font-size: 0.8rem;
            color: var(--text-light);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .chat-preview {
            display: flex;
            flex-direction: column;
        }
        
        .chat-preview .last-message {
            font-size: 0.8rem;
            color: var(--text-light);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .chat-preview .last-time {
            font-size: 0.7rem;
            color: var(--text-light);
            align-self: flex-end;
        }
        
        .chat-actions {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            opacity: 0;
            transition: opacity 0.2s;
        }
        
        .user-item:hover .chat-actions {
            opacity: 1;
        }
        
        .chat-action-btn {
            background: none;
            border: none;
            color: var(--text-light);
            cursor: pointer;
            font-size: 1rem;
            padding: 2px;
            margin-left: 5px;
        }
        
        .chat-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            position: relative;
            height: 100%;
            min-height: 0;
            overflow: hidden;
        }
        
        .chat-header {
            padding: 12px 15px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: var(--header-bg);
            z-index: 10;
            flex-shrink: 0;
            position: sticky;
            top: 0;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .chat-header-left {
            display: flex;
            align-items: center;
            flex: 1;
            min-width: 0;
        }
        
        .chat-header h2 {
            font-size: 1.1rem;
            font-weight: 500;
            margin-left: 12px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .back-btn {
            background: none;
            border: none;
            font-size: 1.2rem;
            margin-right: 10px;
            display: none;
            cursor: pointer;
            color: var(--text-color);
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
        }
        
        .chat-header-actions {
            display: flex;
            gap: 8px;
        }
        
        .chat-header-btn {
            background: none;
            border: none;
            color: var(--text-color);
            cursor: pointer;
            font-size: 1rem;
            padding: 5px;
            border-radius: 50%;
            transition: background 0.2s;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
        }
        
        .chat-header-btn:hover {
            background: var(--message-hover);
        }
        
        .chat-messages {
            flex: 1;
            padding: 15px;
            overflow-y: auto;
            overflow-x: hidden;
            -webkit-overflow-scrolling: touch;
            background: var(--bg-color);
            padding-bottom: 100px;
        }
        
        .message {
            margin-bottom: 12px;
            display: flex;
            flex-direction: column;
            position: relative;
        }
        
        .message.sent {
            align-items: flex-end;
        }
        
        .message.received {
            align-items: flex-start;
        }
        
        .message-content {
            max-width: 85%;
            padding: 10px 14px;
            border-radius: 18px;
            position: relative;
            word-wrap: break-word;
            line-height: 1.4;
            font-size: 0.95rem;
            overflow-wrap: break-word;
            word-break: break-word;
        }
        
        .message.sent .message-content {
            background: var(--sent-message);
            color: white;
            border-bottom-right-radius: 5px;
        }
        
        .message.received .message-content {
            background: var(--received-message);
            border-bottom-left-radius: 5px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }
        
        .message-time {
            font-size: 0.7rem;
            color: var(--text-light);
            margin-top: 4px;
        }
        
        .message-actions {
            position: absolute;
            top: 5px;
            right: 5px;
            opacity: 0;
            transition: opacity 0.2s;
        }
        
        .message:hover .message-actions {
            opacity: 1;
        }
        
        .message-action-btn {
            background: none;
            border: none;
            color: var(--text-light);
            cursor: pointer;
            font-size: 1rem;
            padding: 2px;
            margin-left: 5px;
        }
        
        .message-input {
            padding: 12px 15px;
            border-top: 1px solid var(--border-color);
            display: flex;
            background: var(--header-bg);
            position: sticky;
            bottom: 0;
            z-index: 100;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
            padding-bottom: max(12px, env(safe-area-inset-bottom));
        }
        
        .message-input input {
            flex: 1;
            padding: 10px 15px;
            border: 1px solid var(--border-color);
            border-radius: 20px;
            font-size: 0.95rem;
            outline: none;
            background: var(--input-bg);
            color: var(--text-color);
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
        }
        
        .message-input button {
            margin-left: 8px;
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s;
            flex-shrink: 0;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
        }
        
        .message-input button:active {
            background: var(--primary-dark);
        }
        
        .empty-state {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: var(--text-light);
            padding: 20px;
            text-align: center;
        }
        
        .empty-state svg {
            width: 80px;
            height: 80px;
            margin-bottom: 15px;
            opacity: 0.3;
        }
        
        .empty-state h3 {
            margin-bottom: 8px;
            font-size: 1.2rem;
            font-weight: 500;
        }
        
        .empty-state p {
            font-size: 0.9rem;
        }
        
        .notification {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: var(--notification-bg);
            color: var(--notification-text);
            padding: 12px 20px;
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            opacity: 0;
            transition: all 0.3s ease;
            z-index: 1000;
            max-width: 90%;
            text-align: center;
        }
        
        .notification.show {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
        }
        
        .settings {
            padding: 12px;
            border-top: 1px solid var(--border-color);
            position: sticky;
            bottom: 0;
            background: var(--sidebar-bg);
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .settings-btn {
            width: calc(100% - 24px);
            margin: 0 12px;
            padding: 10px;
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background 0.2s;
            font-size: 0.9rem;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
        }
        
        .settings-btn:active {
            background: var(--primary-dark);
        }
        
        .logout-btn {
            width: calc(100% - 24px);
            margin: 0 12px;
            padding: 10px;
            background: var(--danger-color);
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background 0.2s;
            font-size: 0.9rem;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
        }
        
        .logout-btn:active {
            background: var(--danger-dark);
        }
        
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
            padding: 16px;
        }
        
        .modal.active {
            opacity: 1;
            pointer-events: all;
        }
        
        .modal-content {
            background: var(--modal-bg);
            padding: 20px;
            border-radius: 10px;
            width: 90%;
            max-width: 400px;
            transform: translateY(20px);
            transition: transform 0.3s ease;
            color: var(--text-color);
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .modal.active .modal-content {
            transform: translateY(0) translateZ(0);
        }
        
        .modal-title {
            margin-bottom: 15px;
            text-align: center;
            font-size: 1.2rem;
        }
        
        .modal-input {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border-color);
            border-radius: 5px;
            margin-bottom: 15px;
            font-size: 1rem;
            background: var(--input-bg);
            color: var(--text-color);
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
        }
        
        .modal-actions {
            display: flex;
            gap: 10px;
        }
        
        .modal-btn {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.95rem;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
        }
        
        .modal-btn-primary {
            background: var(--primary-color);
            color: white;
        }
        
        .modal-btn-secondary {
            background: var(--border-color);
            color: var(--text-color);
        }
        
        .theme-toggle {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 15px;
        }
        
        .theme-toggle label {
            display: flex;
            align-items: center;
            cursor: pointer;
        }
        
        .theme-toggle input {
            margin-right: 10px;
        }
        
        .emoji-selector {
            margin-bottom: 15px;
        }
        
        .emoji-options {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
        }
        
        .emoji-option {
            font-size: 1.5rem;
            cursor: pointer;
            padding: 5px;
            border-radius: 5px;
            transition: background 0.2s;
        }
        
        .emoji-option:hover {
            background: var(--message-hover);
        }
        
        .emoji-option.selected {
            background: var(--primary-color);
            color: white;
        }
        
        .group-participants {
            margin-bottom: 15px;
        }
        
        .participants-list {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid var(--border-color);
            border-radius: 5px;
            padding: 10px;
            margin-top: 10px;
        }
        
        .participant-item {
            display: flex;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid var(--border-color);
        }
        
        .participant-item:last-child {
            border-bottom: none;
        }
        
        .participant-checkbox {
            margin-right: 10px;
        }
        
        .blocked-users {
            margin-top: 15px;
        }
        
        .blocked-list {
            max-height: 150px;
            overflow-y: auto;
            border: 1px solid var(--border-color);
            border-radius: 5px;
            padding: 10px;
            margin-top: 10px;
        }
        
        .blocked-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid var(--border-color);
        }
        
        .blocked-item:last-child {
            border-bottom: none;
        }
        
        .unblock-btn {
            background: var(--danger-color);
            color: white;
            border: none;
            border-radius: 3px;
            padding: 3px 8px;
            font-size: 0.8rem;
            cursor: pointer;
        }
        
        /* –°—Ç–∏–ª–∏ –¥–ª—è –∫–∞–Ω–∞–ª–æ–≤ */
        .channel-item {
            padding: 12px 15px;
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
            transition: background 0.2s;
            display: flex;
            align-items: center;
            position: relative;
            background: var(--channel-bg);
        }
        
        .channel-item:active {
            background: var(--channel-hover);
        }
        
        .channel-icon {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: var(--primary-color);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 12px;
            font-weight: bold;
            flex-shrink: 0;
            font-size: 1.2rem;
            overflow: hidden;
        }
        
        .channel-icon iframe {
            width: 100%;
            height: 100%;
            border: none;
            border-radius: 50%;
        }
        
        .channel-icon img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 50%;
        }
        
        .channel-icon-preview {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: var(--primary-color);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 10px auto;
            font-weight: bold;
            font-size: 1.5rem;
            overflow: hidden;
        }
        
        .channel-icon-preview iframe {
            width: 100%;
            height: 100%;
            border: none;
            border-radius: 50%;
        }
        
        .channel-icon-list {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid var(--border-color);
            border-radius: 5px;
            padding: 10px;
            margin-top: 10px;
        }
        
        .channel-icon-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px;
            border-bottom: 1px solid var(--border-color);
        }
        
        .channel-icon-item:last-child {
            border-bottom: none;
        }
        
        .channel-icon-display {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--primary-color);
        }
        
        .channel-icon-display iframe {
            width: 100%;
            height: 100%;
            border: none;
            border-radius: 50%;
        }
        
        .channel-icon-url {
            flex: 1;
            margin: 0 10px;
            font-size: 0.8rem;
            color: var(--text-light);
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .delete-icon-btn {
            background: var(--danger-color);
            color: white;
            border: none;
            border-radius: 3px;
            padding: 5px 10px;
            font-size: 0.8rem;
            cursor: pointer;
        }
        
        .channel-info {
            overflow: hidden;
            flex: 1;
        }
        
        .channel-info h3 {
            font-size: 0.95rem;
            margin-bottom: 3px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            display: flex;
            align-items: center;
        }
        
        .channel-info p {
            font-size: 0.8rem;
            color: var(--text-light);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .channel-subscribers {
            font-size: 0.7rem;
            color: var(--text-light);
            display: flex;
            align-items: center;
        }
        
        .subscribe-btn {
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: 15px;
            padding: 5px 10px;
            font-size: 0.8rem;
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .subscribe-btn:active {
            background: var(--primary-dark);
        }
        
        .subscribe-btn.subscribed {
            background: var(--text-light);
            color: var(--text-color);
        }
        
        /* –°—Ç–∏–ª–∏ –¥–ª—è –º–µ–Ω—é –Ω–∞—Å—Ç—Ä–æ–µ–∫ */
        .settings-menu {
            display: none;
            position: fixed;
            bottom: 100px;
            right: 20px;
            background: var(--modal-bg);
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            z-index: 1000;
            width: 200px;
            overflow: hidden;
            transform: translateY(20px);
            opacity: 0;
            transition: all 0.3s ease;
        }
        
        .settings-menu.active {
            display: block;
            transform: translateY(0);
            opacity: 1;
        }
        
        .settings-menu-item {
            padding: 12px 15px;
            cursor: pointer;
            transition: background 0.2s;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .settings-menu-item:hover {
            background: var(--message-hover);
        }
        
        .settings-menu-item.create-group {
            color: var(--success-color);
        }
        
        .settings-menu-item.create-channel {
            color: var(--primary-color);
        }
        
        .settings-menu-item.logout {
            color: var(--danger-color);
        }
        
        @media (max-width: 768px) {
            .mobile-header {
                display: flex;
                padding-top: max(12px, env(safe-area-inset-top));
                min-height: 56px;
            }
            
            .sidebar {
                position: fixed;
                top: 0;
                left: 0;
                bottom: 0;
                z-index: 200;
                transform: translateX(-100%);
                width: 85%;
                max-width: 320px;
                min-width: 260px;
                height: 100%;
                padding-top: env(safe-area-inset-top);
                padding-bottom: env(safe-area-inset-bottom);
                transition: transform 0.3s ease;
            }
            
            .sidebar.active {
                transform: translateX(0);
                box-shadow: 4px 0 20px rgba(0,0,0,0.3);
            }
            
            .sidebar-overlay {
                display: none;
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0,0,0,0.5);
                z-index: 199;
                opacity: 0;
                transition: opacity 0.3s ease;
            }
            
            .sidebar-overlay.active {
                display: block;
                opacity: 1;
            }
            
            .back-btn {
                display: block;
            }
            
            .chat-header h2 {
                max-width: 200px;
            }
            
            .message-content {
                max-width: 80%;
            }
            
            .message-input {
                padding: 10px;
                padding-bottom: max(10px, env(safe-area-inset-bottom));
                position: fixed;
                left: 0;
                right: 0;
                bottom: 0;
            }
            
            .message-input input {
                padding: 12px 15px;
                font-size: 16px;
                min-height: 44px;
            }
            
            .message-input button {
                width: 44px;
                height: 44px;
            }
            
            .chat-messages {
                padding: 12px;
                padding-bottom: calc(80px + env(safe-area-inset-bottom));
            }
            
            .settings-menu {
                bottom: calc(90px + env(safe-area-inset-bottom));
                right: 10px;
                width: 180px;
            }
            
            .user-profile {
                padding-top: max(15px, env(safe-area-inset-top));
            }
            
            .settings {
                padding-bottom: max(12px, env(safe-area-inset-bottom));
            }
        }
        
        @media (max-width: 480px) {
            .user-profile {
                padding: 12px 10px;
                padding-top: max(12px, env(safe-area-inset-top));
            }
            
            .user-profile h2 {
                font-size: 1.1rem;
            }
            
            .chat-messages {
                padding: 10px;
                padding-bottom: calc(90px + env(safe-area-inset-bottom));
            }
            
            .message-content {
                max-width: 90%;
                padding: 10px 14px;
                font-size: 1rem;
            }
            
            .message-input {
                padding: 8px 10px;
                padding-bottom: max(8px, env(safe-area-inset-bottom));
                gap: 8px;
            }
            
            .message-input input {
                padding: 10px 14px;
                font-size: 16px;
                min-height: 42px;
            }
            
            .message-input button {
                width: 42px;
                height: 42px;
            }
            
            .chat-header {
                padding: 10px 12px;
                min-height: 52px;
                padding-top: max(10px, env(safe-area-inset-top));
            }
            
            .chat-header h2 {
                font-size: 0.95rem;
                max-width: 150px;
                margin-left: 8px;
            }
            
            .back-btn {
                font-size: 1.3rem;
                padding: 6px;
                margin-right: 5px;
            }
            
            .chat-header-btn {
                padding: 6px;
                font-size: 1rem;
            }
            
            .user-avatar {
                width: 32px;
                height: 32px;
                font-size: 0.9rem;
            }
            
            .chat-header-actions {
                gap: 4px;
            }
            
            .modal-content {
                width: 95%;
                padding: 16px;
            }
            
            .modal-title {
                font-size: 1.1rem;
            }
            
            .modal-input {
                padding: 10px;
                font-size: 16px;
            }
            
            .modal-btn {
                padding: 12px;
                font-size: 0.95rem;
            }
            
            .user-item {
                padding: 10px 12px;
            }
            
            .user-info h3 {
                font-size: 0.9rem;
            }
            
            .user-info p {
                font-size: 0.75rem;
            }
            
            .tab {
                padding: 10px 0;
                font-size: 0.85rem;
            }
            
            .search-box {
                padding: 8px 12px;
                font-size: 16px;
            }
            
            .settings-btn, .logout-btn {
                padding: 12px;
                font-size: 0.9rem;
            }
            
            .empty-state h3 {
                font-size: 1.1rem;
            }
            
            .empty-state p {
                font-size: 0.85rem;
            }
            
            .empty-state svg {
                width: 60px;
                height: 60px;
            }
            
            .notification {
                padding: 10px 16px;
                font-size: 0.9rem;
            }
            
            .message {
                margin-bottom: 8px;
            }
            
            .message-time {
                font-size: 0.65rem;
            }
        }
        
        /* Extra small screens */
        @media (max-width: 360px) {
            .sidebar {
                width: 90%;
                min-width: 240px;
            }
            
            .chat-header h2 {
                font-size: 0.9rem;
                max-width: 120px;
            }
            
            .message-content {
                max-width: 92%;
                padding: 8px 12px;
                font-size: 0.95rem;
            }
            
            .user-avatar {
                width: 28px;
                height: 28px;
                font-size: 0.8rem;
            }
            
            .chat-header-btn {
                padding: 5px;
                font-size: 0.9rem;
            }
        }
        
        /* Landscape mode on mobile */
        @media (max-height: 500px) and (orientation: landscape) {
            .mobile-header {
                min-height: 44px;
                padding-top: 8px;
                padding-bottom: 8px;
            }
            
            .chat-header {
                min-height: 44px;
                padding-top: 8px;
                padding-bottom: 8px;
            }
            
            .chat-messages {
                padding-bottom: 70px;
            }
            
            .message-input {
                padding: 6px 10px;
            }
            
            .message-input input {
                min-height: 38px;
            }
            
            .message-input button {
                width: 38px;
                height: 38px;
            }
            
            .sidebar {
                padding-top: 8px;
            }
            
            .user-profile {
                padding: 10px;
            }
        }
    </style>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
</head>
<body>
    <div class="container">
        <div class="mobile-header">
            <button class="mobile-menu-btn" id="menu-btn">‚ò∞</button>
            <h1 id="mobile-title">Twin</h1>
            <div style="width: 24px;"></div>
        </div>
        
        <div class="sidebar-overlay" id="sidebar-overlay"></div>
        
        <div class="content-wrapper">
            <div class="sidebar" id="sidebar">
                <div class="user-profile">
                    <h2 id="current-user">
                        <span class="user-emoji" id="user-emoji">üòä</span>
                        <span>–ó–∞–≥—Ä—É–∑–∫–∞...</span>
                    </h2>
                    <p>
                        –û–Ω–ª–∞–π–Ω
                        <span class="connection-status" id="connection-status"></span>
                    </p>
                </div>
                
                <div class="tabs">
                    <button class="tab active" id="chats-tab">–ß–∞—Ç—ã</button>
                    <button class="tab" id="users-tab">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</button>
                    <button class="tab" id="channels-tab">–ö–∞–Ω–∞–ª—ã</button>
                </div>
                
                <div class="search-container">
                    <input type="text" class="search-box" id="search-input" placeholder="–ü–æ–∏—Å–∫ –ø–æ —é–∑–µ—Ä–Ω–µ–π–º—É...">
                </div>
                
                <div class="search-results" id="search-results">
                    <!-- –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∏—Å–∫–∞ –±—É–¥—É—Ç –∑–¥–µ—Å—å -->
                </div>
                
                <div class="settings">
                    <button class="settings-btn" id="profile-settings-btn">–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–æ—Ñ–∏–ª—è</button>          
                    <button class="settings-btn" id="settings-btn">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</button>
                    <button class="logout-btn" id="logout-btn">–í—ã–π—Ç–∏</button>
                </div>
            </div>
            
            <div class="chat-area">
                <div class="empty-state" id="empty-state">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
                    </svg>
                    <h3>–í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç</h3>
                    <p>–ù–∞–π–¥–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –Ω–∞—á–Ω–∏—Ç–µ –æ–±—â–µ–Ω–∏–µ</p>
                </div>
                
                <div class="chat-header" id="chat-header" style="display: none;">
                    <div class="chat-header-left">
                        <button class="back-btn" id="back-btn">‚Üê</button>
                        <div class="user-avatar" id="chat-avatar">?</div>
                        <h2 id="chat-user-name">
                            <span class="user-emoji-small" id="chat-user-emoji">üòä</span>
                            <span>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</span>
                        </h2>
                    </div>
                    <div class="chat-header-actions">
                        <button class="chat-header-btn" id="close-chat-btn" title="–í–µ—Ä–Ω—É—Ç—å—Å—è –∫ —Å–ø–∏—Å–∫—É —á–∞—Ç–æ–≤">‚Üê</button>
                        <button class="chat-header-btn" id="block-user-btn" title="–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è">üö´</button>
                        <button class="chat-header-btn" id="delete-chat-btn" title="–£–¥–∞–ª–∏—Ç—å —á–∞—Ç">üóëÔ∏è</button>
                        <button class="chat-header-btn" id="group-settings-btn" title="–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –≥—Ä—É–ø–ø—ã" style="display: none;">‚öôÔ∏è</button>
                        <button class="chat-header-btn" id="channel-settings-btn" title="–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∫–∞–Ω–∞–ª–∞" style="display: none;">‚öôÔ∏è</button>
                    </div>
                </div>
                
                <div class="chat-messages" id="chat-messages" style="display: none;">
                    <!-- –°–æ–æ–±—â–µ–Ω–∏—è –±—É–¥—É—Ç –∑–¥–µ—Å—å -->
                </div>
                
                <div class="message-input" id="message-input-container" style="display: none;">
                    <input type="text" id="message-text" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." autocomplete="off">
                    <button id="send-btn">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" />
                        </svg>
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- –ú–µ–Ω—é –Ω–∞—Å—Ç—Ä–æ–µ–∫ -->
    <div class="settings-menu" id="settings-menu">
        <div class="settings-menu-item create-group" id="create-group-menu-btn">
            <span>üë•</span>
            <span>–°–æ–∑–¥–∞—Ç—å –≥—Ä—É–ø–ø—É</span>
        </div>
        <div class="settings-menu-item create-channel" id="create-channel-menu-btn">
            <span>üì¢</span>
            <span>–°–æ–∑–¥–∞—Ç—å –∫–∞–Ω–∞–ª</span>
        </div>
        <div class="settings-menu-item logout" id="logout-menu-btn">
            <span>üö™</span>
            <span>–í—ã–π—Ç–∏</span>
        </div>
    </div>
    
    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π -->
    <div class="notification" id="notification"></div>
    
    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –Ω–∞—Å—Ç—Ä–æ–µ–∫ -->
    <div class="modal" id="settings-modal">
        <div class="modal-content">
            <h2 class="modal-title">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</h2>
            
            <div class="theme-toggle">
                <label>
                    <input type="checkbox" id="theme-toggle">
                    <span>–¢–µ–º–Ω–∞—è —Ç–µ–º–∞</span>
                </label>
            </div>
            
            <div class="theme-toggle" id="notification-toggle-container">
                <label>
                    <input type="checkbox" id="notification-toggle">
                    <span>–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤ –±—Ä–∞—É–∑–µ—Ä–µ</span>
                </label>
            </div>
            <div id="notification-status" style="font-size: 0.8rem; color: var(--text-light); margin-bottom: 10px; display: none;"></div>
            <button class="modal-btn modal-btn-secondary" id="test-notification-btn" style="width: 100%; margin-bottom: 15px; display: none;">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</button>
            
            <div class="emoji-selector">
                <label>–í–∞—à —Å—Ç–∞—Ç—É—Å:</label>
                <div class="emoji-options" id="emoji-options">
                    <span class="emoji-option" data-emoji="üòä">üòä</span>
                    <span class="emoji-option" data-emoji="üòé">üòé</span>
                    <span class="emoji-option" data-emoji="ü§î">ü§î</span>
                    <span class="emoji-option" data-emoji="üò¥">üò¥</span>
                    <span class="emoji-option" data-emoji="üò¢">üò¢</span>
                    <span class="emoji-option" data-emoji="üò°">üò°</span>
                    <span class="emoji-option" data-emoji="ü•≥">ü•≥</span>
                    <span class="emoji-option" data-emoji="üòç">üòç</span>
                </div>
            </div>
            
            <div class="blocked-users">
                <label>–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏:</label>
                <div class="blocked-list" id="blocked-list">
                    <!-- –°–ø–∏—Å–æ–∫ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π -->
                </div>
            </div>
            
            <input type="text" class="modal-input" id="new-username-input" placeholder="–ù–æ–≤—ã–π –Ω–∏–∫–Ω–µ–π–º">
            <div class="modal-actions">
                <button class="modal-btn modal-btn-secondary" id="cancel-settings-btn">–û—Ç–º–µ–Ω–∞</button>
                <button class="modal-btn modal-btn-primary" id="save-settings-btn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            </div>
        </div>
    </div>
    
    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –ø—Ä–æ—Ñ–∏–ª—è -->
    <div class="modal" id="profile-settings-modal">
        <div class="modal-content">
            <h2 class="modal-title">–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–æ—Ñ–∏–ª—è</h2>
            
            <input type="text" class="modal-input" id="profile-username-input" placeholder="–í–∞—à–µ –∏–º—è">
            
            <div class="emoji-selector">
                <label>–í–∞—à —Å—Ç–∞—Ç—É—Å:</label>
                <div class="emoji-options" id="profile-emoji-options">
                    <span class="emoji-option" data-emoji="üòä">üòä</span>
                    <span class="emoji-option" data-emoji="üòé">üòé</span>
                    <span class="emoji-option" data-emoji="ü§î">ü§î</span>
                    <span class="emoji-option" data-emoji="üò¥">üò¥</span>
                    <span class="emoji-option" data-emoji="üò¢">üò¢</span>
                    <span class="emoji-option" data-emoji="üò°">üò°</span>
                    <span class="emoji-option" data-emoji="ü•≥">ü•≥</span>
                    <span class="emoji-option" data-emoji="üòç">üòç</span>
                </div>
            </div>
            
            <div class="modal-actions">
                <button class="modal-btn modal-btn-secondary" id="cancel-profile-settings-btn">–û—Ç–º–µ–Ω–∞</button>
                <button class="modal-btn modal-btn-primary" id="save-profile-settings-btn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            </div>
        </div>
    </div>
    
    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å–æ–∑–¥–∞–Ω–∏—è –≥—Ä—É–ø–ø—ã -->
    <div class="modal" id="create-group-modal">
        <div class="modal-content">
            <h2 class="modal-title">–°–æ–∑–¥–∞–Ω–∏–µ –≥—Ä—É–ø–ø—ã</h2>
            
            <input type="text" class="modal-input" id="group-name-input" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –≥—Ä—É–ø–ø—ã">
            
            <div class="group-participants">
                <label>–£—á–∞—Å—Ç–Ω–∏–∫–∏ –≥—Ä—É–ø–ø—ã:</label>
                <div class="participants-list" id="participants-list">
                    <!-- –°–ø–∏—Å–æ–∫ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ -->
                </div>
            </div>
            
            <div class="modal-actions">
                <button class="modal-btn modal-btn-secondary" id="cancel-group-btn">–û—Ç–º–µ–Ω–∞</button>
                <button class="modal-btn modal-btn-primary" id="create-group-confirm-btn">–°–æ–∑–¥–∞—Ç—å</button>
            </div>
        </div>
    </div>
    
    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å–æ–∑–¥–∞–Ω–∏—è –∫–∞–Ω–∞–ª–∞ -->
    <div class="modal" id="create-channel-modal">
        <div class="modal-content">
            <h2 class="modal-title">–°–æ–∑–¥–∞–Ω–∏–µ –∫–∞–Ω–∞–ª–∞</h2>
            
            <input type="text" class="modal-input" id="channel-name-input" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –∫–∞–Ω–∞–ª–∞">
            <textarea class="modal-input" id="channel-description-input" rows="3" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ –∫–∞–Ω–∞–ª–∞"></textarea>
            
            <div class="modal-actions">
                <button class="modal-btn modal-btn-secondary" id="cancel-channel-btn">–û—Ç–º–µ–Ω–∞</button>
                <button class="modal-btn modal-btn-primary" id="create-channel-confirm-btn">–°–æ–∑–¥–∞—Ç—å</button>
            </div>
        </div>
    </div>
    
    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏—è -->
    <div class="modal" id="edit-message-modal">
        <div class="modal-content">
            <h2 class="modal-title">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è</h2>
            <textarea class="modal-input" id="edit-message-text" rows="3" placeholder="–¢–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è"></textarea>
            <div class="modal-actions">
                <button class="modal-btn modal-btn-secondary" id="cancel-edit-btn">–û—Ç–º–µ–Ω–∞</button>
                <button class="modal-btn modal-btn-primary" id="save-edit-btn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            </div>
        </div>
    </div>
    
    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –≥—Ä—É–ø–ø—ã -->
    <div class="modal" id="group-settings-modal">
        <div class="modal-content">
            <h2 class="modal-title">–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –≥—Ä—É–ø–ø—ã</h2>
            
            <input type="text" class="modal-input" id="edit-group-name-input" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –≥—Ä—É–ø–ø—ã">
            
            <div class="group-participants">
                <label>–£—á–∞—Å—Ç–Ω–∏–∫–∏ –≥—Ä—É–ø–ø—ã:</label>
                <div class="participants-list" id="edit-participants-list">
                    <!-- –°–ø–∏—Å–æ–∫ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ -->
                </div>
            </div>
            
            <div class="modal-actions">
                <button class="modal-btn modal-btn-secondary" id="cancel-group-settings-btn">–û—Ç–º–µ–Ω–∞</button>
                <button class="modal-btn modal-btn-primary" id="save-group-settings-btn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                <button class="modal-btn" id="leave-group-btn" style="background: var(--danger-color); color: white;">–ü–æ–∫–∏–Ω—É—Ç—å –≥—Ä—É–ø–ø—É</button>
            </div>
        </div>
    </div>
    
    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –∫–∞–Ω–∞–ª–∞ -->
    <div class="modal" id="channel-settings-modal">
        <div class="modal-content">
            <h2 class="modal-title">–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∫–∞–Ω–∞–ª–∞</h2>
            
            <input type="text" class="modal-input" id="edit-channel-name-input" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –∫–∞–Ω–∞–ª–∞">
            <textarea class="modal-input" id="edit-channel-description-input" rows="3" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ –∫–∞–Ω–∞–ª–∞"></textarea>
            
            <button class="modal-btn modal-btn-primary" id="manage-channel-icons-btn" style="width: 100%; margin-bottom: 15px; display: none;">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∏–∫–æ–Ω–∫–∞–º–∏</button>
            
            <div class="modal-actions">
                <button class="modal-btn modal-btn-secondary" id="cancel-channel-settings-btn">–û—Ç–º–µ–Ω–∞</button>
                <button class="modal-btn modal-btn-primary" id="save-channel-settings-btn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                <button class="modal-btn" id="unsubscribe-channel-btn" style="background: var(--danger-color); color: white;">–û—Ç–ø–∏—Å–∞—Ç—å—Å—è</button>
            </div>
        </div>
    </div>
    
    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∏–∫–æ–Ω–∫–∞–º–∏ –∫–∞–Ω–∞–ª–∞ (—Ç–æ–ª—å–∫–æ –¥–ª—è –∞–¥–º–∏–Ω–∞) -->
    <div class="modal" id="channel-icons-modal">
        <div class="modal-content">
            <h2 class="modal-title">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∏–∫–æ–Ω–∫–∞–º–∏ –∫–∞–Ω–∞–ª–∞</h2>
            
            <div class="channel-icon-preview" id="channel-icon-preview">
                <span>üì¢</span>
            </div>
            
            <input type="text" class="modal-input" id="channel-icon-url-input" placeholder="URL iframe –¥–ª—è –∏–∫–æ–Ω–∫–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä: https://example.com/icon.html)">
            
            <button class="modal-btn modal-btn-primary" id="add-channel-icon-btn" style="width: 100%; margin-bottom: 15px;">–î–æ–±–∞–≤–∏—Ç—å –∏–∫–æ–Ω–∫—É</button>
            
            <label>–¢–µ–∫—É—â–∏–µ –∏–∫–æ–Ω–∫–∏:</label>
            <div class="channel-icon-list" id="channel-icons-list">
                <div style="text-align: center; color: var(--text-light); padding: 10px;">–ù–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω–Ω—ã—Ö –∏–∫–æ–Ω–æ–∫</div>
            </div>
            
            <div class="modal-actions">
                <button class="modal-btn modal-btn-secondary" id="cancel-channel-icons-btn">–ó–∞–∫—Ä—ã—Ç—å</button>
            </div>
        </div>
    </div>
    
    <script>
        // Firebase –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
        const firebaseConfig = {
            apiKey: "AIzaSyAhO3JsDI61pkpGla045EfEXq6h7EuGHoQ",
            authDomain: "ukraine-52ad4.firebaseapp.com",
            databaseURL: "https://ukraine-52ad4-default-rtdb.firebaseio.com",
            projectId: "ukraine-52ad4",
            storageBucket: "ukraine-52ad4.firebasestorage.app",
            messagingSenderId: "63107581219",
            appId: "1:63107581219:web:074b8e692a8a8b04737896",
            measurementId: "G-J4M8NV6TC9"
        };

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Firebase
        let database;
        try {
            firebase.initializeApp(firebaseConfig);
            database = firebase.database();
            console.log('Firebase –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω —É—Å–ø–µ—à–Ω–æ');
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ Firebase:', error);
        }

        // –≠–ª–µ–º–µ–Ω—Ç—ã DOM
        const currentUserEl = document.getElementById('current-user');
        const userEmojiEl = document.getElementById('user-emoji');
        const searchInput = document.getElementById('search-input');
        const searchResults = document.getElementById('search-results');
        const emptyState = document.getElementById('empty-state');
        const chatHeader = document.getElementById('chat-header');
        const chatAvatar = document.getElementById('chat-avatar');
        const chatUserName = document.getElementById('chat-user-name');
        const chatUserEmoji = document.getElementById('chat-user-emoji');
        const chatMessages = document.getElementById('chat-messages');
        const messageInputContainer = document.getElementById('message-input-container');
        const messageText = document.getElementById('message-text');
        const sendBtn = document.getElementById('send-btn');
        const logoutBtn = document.getElementById('logout-btn');
        const settingsBtn = document.getElementById('settings-btn');
        const notification = document.getElementById('notification');
        const menuBtn = document.getElementById('menu-btn');
        const backBtn = document.getElementById('back-btn');
        const closeChatBtn = document.getElementById('close-chat-btn');
        const sidebar = document.getElementById('sidebar');
        const mobileTitle = document.getElementById('mobile-title');
        const settingsModal = document.getElementById('settings-modal');
        const newUsernameInput = document.getElementById('new-username-input');
        const cancelSettingsBtn = document.getElementById('cancel-settings-btn');
        const saveSettingsBtn = document.getElementById('save-settings-btn');
        const chatsTab = document.getElementById('chats-tab');
        const usersTab = document.getElementById('users-tab');
        const channelsTab = document.getElementById('channels-tab');
        const themeToggle = document.getElementById('theme-toggle');
        const notificationToggle = document.getElementById('notification-toggle');
        const notificationStatus = document.getElementById('notification-status');
        const testNotificationBtn = document.getElementById('test-notification-btn');
        const emojiOptions = document.getElementById('emoji-options');
        const editMessageModal = document.getElementById('edit-message-modal');
        const editMessageText = document.getElementById('edit-message-text');
        const cancelEditBtn = document.getElementById('cancel-edit-btn');
        const saveEditBtn = document.getElementById('save-edit-btn');
        const createGroupBtn = document.getElementById('create-group-menu-btn');
        const createGroupModal = document.getElementById('create-group-modal');
        const groupNameInput = document.getElementById('group-name-input');
        const participantsList = document.getElementById('participants-list');
        const cancelGroupBtn = document.getElementById('cancel-group-btn');
        const createGroupConfirmBtn = document.getElementById('create-group-confirm-btn');
        const blockUserBtn = document.getElementById('block-user-btn');
        const deleteChatBtn = document.getElementById('delete-chat-btn');
        const connectionStatus = document.getElementById('connection-status');
        const blockedList = document.getElementById('blocked-list');
        const groupSettingsBtn = document.getElementById('group-settings-btn');
        const groupSettingsModal = document.getElementById('group-settings-modal');
        const editGroupNameInput = document.getElementById('edit-group-name-input');
        const editParticipantsList = document.getElementById('edit-participants-list');
        const cancelGroupSettingsBtn = document.getElementById('cancel-group-settings-btn');
        const saveGroupSettingsBtn = document.getElementById('save-group-settings-btn');
        const leaveGroupBtn = document.getElementById('leave-group-btn');
        const createChannelBtn = document.getElementById('create-channel-menu-btn');
        const createChannelModal = document.getElementById('create-channel-modal');
        const channelNameInput = document.getElementById('channel-name-input');
        const channelDescriptionInput = document.getElementById('channel-description-input');
        const cancelChannelBtn = document.getElementById('cancel-channel-btn');
        const createChannelConfirmBtn = document.getElementById('create-channel-confirm-btn');
        const channelSettingsBtn = document.getElementById('channel-settings-btn');
        const channelSettingsModal = document.getElementById('channel-settings-modal');
        const editChannelNameInput = document.getElementById('edit-channel-name-input');
        const editChannelDescriptionInput = document.getElementById('edit-channel-description-input');
        const cancelChannelSettingsBtn = document.getElementById('cancel-channel-settings-btn');
        const saveChannelSettingsBtn = document.getElementById('save-channel-settings-btn');
        const unsubscribeChannelBtn = document.getElementById('unsubscribe-channel-btn');
        const settingsMenu = document.getElementById('settings-menu');
        const logoutMenuBtn = document.getElementById('logout-menu-btn');
        const sidebarOverlay = document.getElementById('sidebar-overlay');
        
        // –≠–ª–µ–º–µ–Ω—Ç—ã –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∏–∫–æ–Ω–∫–∞–º–∏ –∫–∞–Ω–∞–ª–æ–≤
        const channelIconsModal = document.getElementById('channel-icons-modal');
        const channelIconUrlInput = document.getElementById('channel-icon-url-input');
        const addChannelIconBtn = document.getElementById('add-channel-icon-btn');
        const cancelChannelIconsBtn = document.getElementById('cancel-channel-icons-btn');
        const channelIconsList = document.getElementById('channel-icons-list');
        const channelIconPreview = document.getElementById('channel-icon-preview');
        const manageChannelIconsBtn = document.getElementById('manage-channel-icons-btn');
        
        // –°–æ—Å—Ç–æ—è–Ω–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
        let currentUser = null;
        let currentChat = null;
        let currentChatType = null; // 'user', 'group', 'channel'
        let messageListeners = {};
        let activeTab = 'chats';
        let userEmoji = 'üòä';
        let editingMessageId = null;
        let isOnline = navigator.onLine;
        let blockedUsers = [];
        let groups = [];
        let currentGroup = null;
        let channels = [];
        let currentChannel = null;
        let subscribedChannels = [];
        let lastMessageTimestamp = 0;
        let backgroundCheckIntervals = [];
        let notifiedMessageIds = new Set();
        
        // –§—É–Ω–∫—Ü–∏—è –ø–æ–∫–∞–∑–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
        function showNotification(message) {
            if (!notification) {
                console.log('Notification:', message);
                return;
            }
            notification.textContent = message;
            notification.classList.add('show');
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        document.addEventListener('DOMContentLoaded', initApp);
        
        async function initApp() {
            setupEventListeners();
            setupNetworkStatus();
            
            // –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º Service Worker –¥–ª—è —Ñ–æ–Ω–æ–≤—ã—Ö —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
            registerServiceWorker();
            
            // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –∑–∞–ø—Ä–æ—Å —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è –Ω–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
            setupAutoNotificationRequest();
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—É—é —Ç–µ–º—É
            if (localStorage.getItem('dark_theme') === 'true') {
                document.body.classList.add('dark-theme');
                themeToggle.checked = true;
            }
            
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
            initializeNotificationSettings();
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
            const savedUser = localStorage.getItem('messenger_user');
            if (savedUser) {
                try {
                    const userData = JSON.parse(savedUser);
                    if (userData && userData.username && userData.password) {
                        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –≤—Ö–æ–¥
                        const userRef = database.ref('users/' + encodeURIComponent(userData.username));
                        const snapshot = await userRef.once('value');
                        
                        if (snapshot.exists()) {
                            const dbUserData = snapshot.val();
                            if (dbUserData.password === userData.password) {
                                currentUser = userData.username;
                                currentUserData = dbUserData;
                                userEmoji = dbUserData.emoji || 'üòä';
                                blockedUsers = dbUserData.blockedUsers || [];
                                subscribedChannels = dbUserData.subscribedChannels || [];
                                
                                currentUserEl.querySelector('span:last-child').textContent = dbUserData.name || userData.username;
                                userEmojiEl.textContent = userEmoji;
                                
                                await updateUserStatus(true);
                                loadRecentChats();
                                loadGroups();
                                loadChannels();
                                
                                startBackgroundChecks();
                                trackUserStatus();
                                subscribeToPushNotifications();
                            } else {
                                localStorage.removeItem('messenger_user');
                                requestUsername();
                            }
                        } else {
                            localStorage.removeItem('messenger_user');
                            requestUsername();
                        }
                    } else {
                        localStorage.removeItem('messenger_user');
                        requestUsername();
                    }
                } catch (e) {
                    localStorage.removeItem('messenger_user');
                    requestUsername();
                }
            } else {
                // –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–µ—Ç, –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –≤—Ö–æ–¥/—Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é
                requestUsername();
            }
            
            // –ê–¥–∞–ø—Ç–∞—Ü–∏—è –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö
            if (window.innerWidth <= 768) {
                mobileTitle.textContent = 'Twin';
            }
            
            // –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –¥–ª—è Android
            optimizeForAndroid();
        }
        
        // –§—É–Ω–∫—Ü–∏—è –∑–∞–ø—Ä–æ—Å–∞ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è –Ω–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
        function requestNotificationPermission() {
            if (!("Notification" in window)) {
                console.log("–ë—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è");
                return Promise.resolve("not_supported");
            }
            
            // –ï—Å–ª–∏ —É–∂–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–æ - –Ω–∏—á–µ–≥–æ –Ω–µ –¥–µ–ª–∞–µ–º
            if (Notification.permission === "granted") {
                return Promise.resolve("granted");
            }
            
            // –ï—Å–ª–∏ –∑–∞–ø—Ä–µ—â–µ–Ω–æ - –Ω–µ –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ–º
            if (Notification.permission === "denied") {
                return Promise.resolve("denied");
            }
            
            // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ
            return Notification.requestPermission();
        }
        
        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –∑–∞–ø—Ä–æ—Å —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è –Ω–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–∏
        function setupAutoNotificationRequest() {
            if (!("Notification" in window)) return;
            if (Notification.permission !== "default") return;
            
            const autoRequestPermission = () => {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –∑–∞–ø—Ä–∞—à–∏–≤–∞–ª–∏ –ª–∏ —É–∂–µ
                const alreadyRequested = sessionStorage.getItem('notification_requested');
                if (alreadyRequested) return;
                
                Notification.requestPermission().then(permission => {
                    sessionStorage.setItem('notification_requested', 'true');
                    if (permission === "granted") {
                        console.log("–†–∞–∑—Ä–µ—à–µ–Ω–∏–µ –Ω–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ø–æ–ª—É—á–µ–Ω–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏");
                        localStorage.setItem('notifications_enabled', 'true');
                        showNotification('–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤–∫–ª—é—á–µ–Ω—ã!');
                    }
                });
            };
            
            // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –∫–ª–∏–∫–µ –∏–ª–∏ –Ω–∞–∂–∞—Ç–∏–∏ –∫–ª–∞–≤–∏—à–∏
            document.addEventListener('click', autoRequestPermission, { once: true });
            document.addEventListener('keypress', autoRequestPermission, { once: true });
        }
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–∫ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        function initializeNotificationSettings() {
            if (!("Notification" in window)) {
                localStorage.setItem('notifications_enabled', 'false');
                return;
            }
            
            // –ï—Å–ª–∏ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ –ø–æ–ª—É—á–µ–Ω–æ, –Ω–æ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –µ—â–µ –Ω–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞ - –≤–∫–ª—é—á–∞–µ–º –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
            if (Notification.permission === "granted") {
                if (localStorage.getItem('notifications_enabled') === null) {
                    localStorage.setItem('notifications_enabled', 'true');
                }
            } else if (Notification.permission === "denied") {
                localStorage.setItem('notifications_enabled', 'false');
            }
        }
        
        // –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è Service Worker
        function registerServiceWorker() {
            // Service Worker –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ file:// –ø—Ä–æ—Ç–æ–∫–æ–ª–µ (–ª–æ–∫–∞–ª—å–Ω—ã–µ —Ñ–∞–π–ª—ã)
            // –û–Ω —Ç—Ä–µ–±—É–µ—Ç HTTPS –∏–ª–∏ localhost
            if ('serviceWorker' in navigator) {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –Ω–µ –æ—Ç–∫—Ä—ã—Ç–∞ —Å file:// –ø—Ä–æ—Ç–æ–∫–æ–ª–∞ –∏–ª–∏ blob:// –ø—Ä–æ—Ç–æ–∫–æ–ª–∞
                if (window.location.protocol === 'file:' || window.location.protocol === 'blob:') {
                    console.log('Service Worker –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ —Ñ–∞–π–ª–∞ –ª–æ–∫–∞–ª—å–Ω–æ (file://) –∏–ª–∏ —á–µ—Ä–µ–∑ blob:// –ø—Ä–æ—Ç–æ–∫–æ–ª. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ª–æ–∫–∞–ª—å–Ω—ã–π —Å–µ—Ä–≤–µ—Ä (Live Server) –∏–ª–∏ —Ä–∞–∑–º–µ—Å—Ç–∏—Ç–µ –Ω–∞ —Ö–æ—Å—Ç–∏–Ω–≥–µ.');
                    return;
                }
                
                const swCode = `
                    self.addEventListener('push', function(event) {
                        const data = event.data.json();
                        const options = {
                            body: data.body,
                            icon: data.icon || 'https://cdn.jsdelivr.net/npm/emoji-datasource-apple@7.0.2/img/apple/64/1f604.png',
                            badge: 'https://cdn.jsdelivr.net/npm/emoji-datasource-apple@7.0.2/img/apple/64/1f604.png',
                            tag: data.tag || 'message',
                            requireInteraction: true,
                            actions: [
                                {
                                    action: 'open',
                                    title: '–û—Ç–∫—Ä—ã—Ç—å'
                                },
                                {
                                    action: 'close',
                                    title: '–ó–∞–∫—Ä—ã—Ç—å'
                                }
                            ]
                        };
                        
                        event.waitUntil(
                            self.registration.showNotification(data.title, options)
                        );
                    });
                    
                    self.addEventListener('notificationclick', function(event) {
                        event.notification.close();
                        
                        if (event.action === 'open' || event.action === '') {
                            event.waitUntil(
                                clients.matchAll({type: 'window'}).then(function(clientList) {
                                    if (clientList.length > 0) {
                                        return clientList[0].focus();
                                    }
                                    return clients.openWindow('/');
                                })
                            );
                        }
                    });
                    
                    self.addEventListener('install', function(event) {
                        self.skipWaiting();
                    });
                    
                    self.addEventListener('activate', function(event) {
                        event.waitUntil(self.clients.claim());
                    });
                `;
                
                const blob = new Blob([swCode], {type: 'application/javascript'});
                const swUrl = URL.createObjectURL(blob);
                
                navigator.serviceWorker.register(swUrl)
                    .then(function(registration) {
                        console.log('Service Worker –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω:', registration);
                    })
                    .catch(function(error) {
                        console.log('–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ Service Worker:', error);
                    });
            }
        }
        
        // –ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ push-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è —á–µ—Ä–µ–∑ Firebase
        function subscribeToPushNotifications() {
            if (!currentUser) return;
            
            // –°–æ–∑–¥–∞–µ–º —Å–ª—É—à–∞—Ç–µ–ª—å –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –≤ Firebase
            const notificationsRef = database.ref('users/' + encodeURIComponent(currentUser) + '/notifications');
            
            notificationsRef.on('child_added', (snapshot) => {
                const notification = snapshot.val();
                if (notification && !notification.read) {
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –±—Ä–∞—É–∑–µ—Ä–Ω–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
                    showBrowserNotification(
                        getNotificationTitle(notification),
                        getNotificationBody(notification)
                    );
                    
                    // –ü–æ–º–µ—á–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∫–∞–∫ –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω–æ–µ
                    snapshot.ref.update({ read: true });
                }
            });
        }
        
        // –ü–æ–ª—É—á–µ–Ω–∏–µ –∑–∞–≥–æ–ª–æ–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
        function getNotificationTitle(notification) {
            switch (notification.type) {
                case 'message':
                    return '–ù–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ';
                case 'group_message':
                    return `–°–æ–æ–±—â–µ–Ω–∏–µ –≤ –≥—Ä—É–ø–ø–µ "${notification.chatName || '–ì—Ä—É–ø–ø–∞'}"`;
                case 'channel_message':
                    return `–°–æ–æ–±—â–µ–Ω–∏–µ –≤ –∫–∞–Ω–∞–ª–µ "${notification.chatName || '–ö–∞–Ω–∞–ª'}"`;
                case 'group_invite':
                    return '–ü—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ –≤ –≥—Ä—É–ø–ø—É';
                case 'group_remove':
                    return '–ì—Ä—É–ø–ø–∞';
                case 'new_subscriber':
                    return '–ù–æ–≤—ã–π –ø–æ–¥–ø–∏—Å—á–∏–∫';
                default:
                    return 'Twin Messenger';
            }
        }
        
        // –ü–æ–ª—É—á–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
        function getNotificationBody(notification) {
            switch (notification.type) {
                case 'message':
                case 'group_message':
                case 'channel_message':
                    return `${notification.from}: ${notification.text || '–ù–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ'}`;
                case 'group_invite':
                    return `${notification.from} –¥–æ–±–∞–≤–∏–ª –≤–∞—Å –≤ –≥—Ä—É–ø–ø—É "${notification.groupName}"`;
                case 'group_remove':
                    return `–í—ã —É–¥–∞–ª–µ–Ω—ã –∏–∑ –≥—Ä—É–ø–ø—ã "${notification.groupName}"`;
                case 'new_subscriber':
                    return `${notification.from} –ø–æ–¥–ø–∏—Å–∞–ª—Å—è –Ω–∞ –≤–∞—à –∫–∞–Ω–∞–ª "${notification.channelName}"`;
                default:
                    return notification.text || '–ù–æ–≤–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ';
            }
        }
        
        function optimizeForAndroid() {
            // –ë–∞–∑–æ–≤–∞—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤
            if ('ontouchstart' in window) {
                document.body.classList.add('touch-device');
            }
            
            // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—è –ø—Ä–∏ —Ñ–æ–∫—É—Å–µ –Ω–∞ –ø–æ–ª–µ –≤–≤–æ–¥–∞
            messageText.addEventListener('focus', function() {
                setTimeout(() => {
                    window.scrollTo(0, 0);
                }, 100);
            });
        }
        
        // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Å–≤–∞–π–ø-–∂–µ—Å—Ç–æ–≤ –¥–ª—è –º–æ–±–∏–ª—å–Ω–æ–π –Ω–∞–≤–∏–≥–∞—Ü–∏–∏
        function setupSwipeGestures() {
            // –°–≤–∞–π–ø—ã –≤—Ä–µ–º–µ–Ω–Ω–æ –æ—Ç–∫–ª—é—á–µ–Ω—ã –¥–ª—è —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏
            // –ú–æ–∂–Ω–æ –≤–∫–ª—é—á–∏—Ç—å –ø–æ–∑–∂–µ, –µ—Å–ª–∏ –ø–æ—Ç—Ä–µ–±—É–µ—Ç—Å—è
            return;
        }
        
        function openProfileSettings() {
            document.getElementById('profile-username-input').value = currentUserData ? (currentUserData.name || '') : '';
            
            document.querySelectorAll('#profile-emoji-options .emoji-option').forEach(opt => {
                opt.classList.remove('selected');
                if (opt.dataset.emoji === userEmoji) {
                    opt.classList.add('selected');
                }
            });
            
            document.getElementById('profile-settings-modal').classList.add('active');
        }

        function closeProfileSettings() {
            document.getElementById('profile-settings-modal').classList.remove('active');
        }

        async function saveProfileSettings() {
            const newName = document.getElementById('profile-username-input').value.trim();
            
            if (!newName) {
                showNotification('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –∏–º—è');
                return;
            }
            
            try {
                await database.ref('users/' + encodeURIComponent(currentUser)).update({
                    name: newName,
                    emoji: userEmoji
                });
                
                if (currentUserData) {
                    currentUserData.name = newName;
                    currentUserData.emoji = userEmoji;
                }
                
                userEmojiEl.textContent = userEmoji;
                currentUserEl.querySelector('span:last-child').textContent = newName;
                showNotification('–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–æ—Ñ–∏–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã');
                closeProfileSettings();
                
            } catch (error) {
                showNotification('–û—à–∏–±–∫–∞: ' + error.message);
            }
        }
        
        function setupEventListeners() {
            document.getElementById('profile-emoji-options').addEventListener('click', (e) => {
                if (e.target.classList.contains('emoji-option')) {
                    document.querySelectorAll('#profile-emoji-options .emoji-option').forEach(opt => {
                        opt.classList.remove('selected');
                    });
                    e.target.classList.add('selected');
                    userEmoji = e.target.dataset.emoji;
                }
            });
            
            searchInput.addEventListener('input', debounce(handleSearch, 300));
            
            sendBtn.addEventListener('click', sendMessage);
            
            messageText.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') sendMessage();
            });
            
            messageText.addEventListener('focus', () => {
                setTimeout(() => {
                    scrollToBottom();
                }, 300);
            });
            
            logoutBtn.addEventListener('click', handleLogout);
            logoutMenuBtn.addEventListener('click', handleLogout);
            
            settingsBtn.addEventListener('click', toggleSettingsMenu);
            cancelSettingsBtn.addEventListener('click', closeSettings);
            saveSettingsBtn.addEventListener('click', saveSettings);
            
            document.getElementById('profile-settings-btn').addEventListener('click', openProfileSettings);
            document.getElementById('cancel-profile-settings-btn').addEventListener('click', closeProfileSettings);
            document.getElementById('save-profile-settings-btn').addEventListener('click', saveProfileSettings);
            
            createGroupBtn.addEventListener('click', openCreateGroup);
            cancelGroupBtn.addEventListener('click', closeCreateGroup);
            createGroupConfirmBtn.addEventListener('click', createGroup);
            
            createChannelBtn.addEventListener('click', openCreateChannel);
            cancelChannelBtn.addEventListener('click', closeCreateChannel);
            createChannelConfirmBtn.addEventListener('click', createChannel);
            
            groupSettingsBtn.addEventListener('click', openGroupSettings);
            cancelGroupSettingsBtn.addEventListener('click', closeGroupSettings);
            saveGroupSettingsBtn.addEventListener('click', saveGroupSettings);
            leaveGroupBtn.addEventListener('click', leaveGroup);
            
            channelSettingsBtn.addEventListener('click', openChannelSettings);
            cancelChannelSettingsBtn.addEventListener('click', closeChannelSettings);
            saveChannelSettingsBtn.addEventListener('click', saveChannelSettings);
            unsubscribeChannelBtn.addEventListener('click', unsubscribeChannel);
            
            // Event listeners for channel icon management
            manageChannelIconsBtn.addEventListener('click', openChannelIconsModal);
            cancelChannelIconsBtn.addEventListener('click', closeChannelIconsModal);
            addChannelIconBtn.addEventListener('click', addChannelIcon);
            
            // Preview icon on input change
            channelIconUrlInput.addEventListener('input', updateChannelIconPreview);
            
            themeToggle.addEventListener('change', toggleTheme);
            notificationToggle.addEventListener('change', toggleNotifications);
            testNotificationBtn.addEventListener('click', testNotification);
            
            emojiOptions.addEventListener('click', (e) => {
                if (e.target.classList.contains('emoji-option')) {
                    document.querySelectorAll('.emoji-option').forEach(opt => {
                        opt.classList.remove('selected');
                    });
                    e.target.classList.add('selected');
                    userEmoji = e.target.dataset.emoji;
                }
            });
            
            cancelEditBtn.addEventListener('click', closeEditMessage);
            saveEditBtn.addEventListener('click', saveEditedMessage);
            
            menuBtn.addEventListener('click', toggleSidebar);
            backBtn.addEventListener('click', closeChat);
            closeChatBtn.addEventListener('click', closeChat);
            
            // Close sidebar when clicking overlay
            sidebarOverlay.addEventListener('click', closeSidebar);
            
            document.addEventListener('click', (e) => {
                if (window.innerWidth <= 768 && !sidebar.contains(e.target) && 
                    e.target !== menuBtn && !menuBtn.contains(e.target)) {
                    closeSidebar();
                }
                
                if (!settingsMenu.contains(e.target) && e.target !== settingsBtn && !settingsBtn.contains(e.target)) {
                    settingsMenu.classList.remove('active');
                }
            });
            
            window.addEventListener('resize', handleResize);
            
            chatsTab.addEventListener('click', () => switchTab('chats'));
            usersTab.addEventListener('click', () => switchTab('users'));
            channelsTab.addEventListener('click', () => switchTab('channels'));
            
            blockUserBtn.addEventListener('click', toggleBlockUser);
            deleteChatBtn.addEventListener('click', deleteChat);
            
            window.addEventListener('online', () => {
                isOnline = true;
                updateConnectionStatus();
                showNotification('–í—ã –≤ —Å–µ—Ç–∏');
            });
            
            window.addEventListener('offline', () => {
                isOnline = false;
                updateConnectionStatus();
                showNotification('–í—ã –Ω–µ –≤ —Å–µ—Ç–∏');
            });
        }
        
        function toggleSettingsMenu() {
            settingsMenu.classList.toggle('active');
            updateNotificationToggleState();
        }
        
        function updateNotificationToggleState() {
            if (!("Notification" in window)) {
                notificationToggle.disabled = true;
                notificationStatus.style.display = 'block';
                notificationStatus.textContent = '–í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è';
                testNotificationBtn.style.display = 'none';
                return;
            }
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
            const notificationsEnabled = localStorage.getItem('notifications_enabled') === 'true';
            
            if (Notification.permission === "granted") {
                notificationToggle.checked = notificationsEnabled;
                notificationToggle.disabled = false;
                notificationStatus.style.display = 'none';
                testNotificationBtn.style.display = notificationsEnabled ? 'block' : 'none';
            } else if (Notification.permission === "denied") {
                notificationToggle.checked = false;
                notificationToggle.disabled = true;
                notificationStatus.style.display = 'block';
                notificationStatus.textContent = '–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω—ã –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö –±—Ä–∞—É–∑–µ—Ä–∞. –ß—Ç–æ–±—ã –≤–∫–ª—é—á–∏—Ç—å, –∏–∑–º–µ–Ω–∏—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–∞–π—Ç–∞ –≤ –±—Ä–∞—É–∑–µ—Ä–µ.';
                testNotificationBtn.style.display = 'none';
                localStorage.setItem('notifications_enabled', 'false');
            } else {
                notificationToggle.checked = false;
                notificationToggle.disabled = false;
                notificationStatus.style.display = 'none';
                testNotificationBtn.style.display = 'none';
            }
        }
        
        function testNotification() {
            if (!("Notification" in window)) {
                showNotification('–í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è');
                return;
            }
            
            if (Notification.permission !== "granted") {
                // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ –µ—Å–ª–∏ –µ—â–µ –Ω–µ –ø–æ–ª—É—á–µ–Ω–æ
                Notification.requestPermission().then(permission => {
                    if (permission === "granted") {
                        localStorage.setItem('notifications_enabled', 'true');
                        showBrowserNotification('Twin Messenger', '–≠—Ç–æ —Ç–µ—Å—Ç–æ–≤–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ! –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è —Ä–∞–±–æ—Ç–∞—é—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ.');
                        showNotification('–¢–µ—Å—Ç–æ–≤–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ');
                        updateNotificationToggleState();
                    } else {
                        showNotification('–†–∞–∑—Ä–µ—à–µ–Ω–∏–µ –Ω–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –Ω–µ –ø–æ–ª—É—á–µ–Ω–æ');
                    }
                });
            } else {
                showBrowserNotification('Twin Messenger', '–≠—Ç–æ —Ç–µ—Å—Ç–æ–≤–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ! –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è —Ä–∞–±–æ—Ç–∞—é—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ.');
                showNotification('–¢–µ—Å—Ç–æ–≤–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ');
            }
        }
        
        function toggleNotifications() {
            if (notificationToggle.checked) {
                // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ
                if ("Notification" in window) {
                    if (Notification.permission === "default") {
                        Notification.requestPermission().then(permission => {
                            if (permission === "granted") {
                                console.log("–†–∞–∑—Ä–µ—à–µ–Ω–∏–µ –Ω–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ø–æ–ª—É—á–µ–Ω–æ");
                                localStorage.setItem('notifications_enabled', 'true');
                                showNotification('–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤–∫–ª—é—á–µ–Ω—ã!');
                            } else {
                                notificationToggle.checked = false;
                                localStorage.setItem('notifications_enabled', 'false');
                                updateNotificationToggleState();
                            }
                        });
                    } else if (Notification.permission === "granted") {
                        localStorage.setItem('notifications_enabled', 'true');
                        showNotification('–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤–∫–ª—é—á–µ–Ω—ã!');
                    } else if (Notification.permission === "denied") {
                        notificationToggle.checked = false;
                        localStorage.setItem('notifications_enabled', 'false');
                        updateNotificationToggleState();
                    }
                }
            } else {
                localStorage.setItem('notifications_enabled', 'false');
                showNotification('–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ—Ç–∫–ª—é—á–µ–Ω—ã');
            }
            updateNotificationToggleState();
        }
        
        function setupNetworkStatus() {
            updateConnectionStatus();
        }
        
        function updateConnectionStatus() {
            if (isOnline) {
                connectionStatus.classList.remove('offline');
                document.querySelector('.user-profile p').innerHTML = '–û–Ω–ª–∞–π–Ω <span class="connection-status" id="connection-status"></span>';
            } else {
                connectionStatus.classList.add('offline');
                document.querySelector('.user-profile p').innerHTML = '–û—Ñ–ª–∞–π–Ω <span class="connection-status offline" id="connection-status"></span>';
            }
        }
        
        function startBackgroundChecks() {
            // Clear any existing intervals first to prevent duplicates
            backgroundCheckIntervals.forEach(intervalId => clearInterval(intervalId));
            backgroundCheckIntervals = [];
            
            // Clear notified message IDs when restarting checks
            notifiedMessageIds.clear();
            
            backgroundCheckIntervals.push(setInterval(checkForNewMessages, 5000));
            backgroundCheckIntervals.push(setInterval(checkForGroupInvites, 10000));
            backgroundCheckIntervals.push(setInterval(checkForChannelUpdates, 15000));
        }
        
        async function checkForNewMessages() {
            if (!currentUser || !isOnline) {
                console.log('[CheckMessages] Skipping: no user or offline');
                return;
            }
            
            try {
                console.log('[CheckMessages] Checking for new messages...');
                const snapshot = await database.ref('messages').once('value');
                const allChats = snapshot.val();
                if (!allChats) {
                    console.log('[CheckMessages] No chats found');
                    return;
                }
                
                const now = Date.now();
                // Initialize lastMessageTimestamp on first run to current time to avoid showing old messages
                if (lastMessageTimestamp === 0) {
                    lastMessageTimestamp = now - 5000; // Allow messages from last 5 seconds
                    console.log('[CheckMessages] Initialized timestamp:', lastMessageTimestamp);
                }
                
                Object.keys(allChats).forEach(chatId => {
                    if (chatId.includes(currentUser) || (chatId.startsWith('group_') && groups.some(g => g.id === chatId)) || 
                        (chatId.startsWith('channel_') && subscribedChannels.includes(chatId))) {
                        const messages = allChats[chatId];
                        const messagesArray = Object.keys(messages).map(key => ({
                            id: key,
                            ...messages[key]
                        }));
                        
                        const latestMessage = messagesArray
                            .filter(msg => msg.text && msg.sender && msg.timestamp)
                            .sort((a, b) => b.timestamp - a.timestamp)[0];
                        
                        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –Ω–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
                        if (!latestMessage) return;
                        
                        // Check if we've already notified about this specific message
                        const messageId = latestMessage.id;
                        const isNewMessage = latestMessage.timestamp > lastMessageTimestamp;
                        const isNotFromMe = latestMessage.sender !== currentUser;
                        const notAlreadyNotified = !notifiedMessageIds.has(messageId);
                        
                        if (isNewMessage && isNotFromMe && notAlreadyNotified) {
                            console.log('[CheckMessages] New message found:', latestMessage.text, 'from:', latestMessage.sender);
                            
                            // Mark this message as notified
                            notifiedMessageIds.add(messageId);
                            
                            // Limit the size of the set to prevent memory leaks
                            if (notifiedMessageIds.size > 100) {
                                const firstId = notifiedMessageIds.values().next().value;
                                notifiedMessageIds.delete(firstId);
                            }
                            
                            let senderName = latestMessage.sender;
                            let chatName = '';
                            let notificationType = 'message';
                            
                            if (chatId.startsWith('group_')) {
                                const group = groups.find(g => g.id === chatId);
                                if (group) {
                                    chatName = group.name;
                                    senderName = `${group.name}`;
                                    notificationType = 'group_message';
                                }
                            } else if (chatId.startsWith('channel_')) {
                                const channel = channels.find(c => c.id === chatId);
                                if (channel) {
                                    chatName = channel.name;
                                    senderName = `${channel.name}`;
                                    notificationType = 'channel_message';
                                }
                            } else {
                                // –õ–∏—á–Ω—ã–π —á–∞—Ç
                                chatName = latestMessage.sender;
                            }
                            
                            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –±—Ä–∞—É–∑–µ—Ä–Ω–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –í–°–ï–ì–î–ê, –µ—Å–ª–∏:
                            // 1. –í–∫–ª–∞–¥–∫–∞ –Ω–µ –∞–∫—Ç–∏–≤–Ω–∞ (document.hidden) –ò–õ–ò
                            // 2. –ß–∞—Ç –Ω–µ –æ—Ç–∫—Ä—ã—Ç (currentChat !== chatId)
                            const shouldNotify = document.hidden || currentChat !== chatId;
                            console.log('[CheckMessages] Should notify:', shouldNotify, 'hidden:', document.hidden, 'currentChat:', currentChat, 'chatId:', chatId);
                            
                            if (shouldNotify) {
                                showBrowserNotification(
                                    `–ù–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç ${chatName}`,
                                    latestMessage.text
                                );
                            }
                            
                            // –°–æ–∑–¥–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤ Firebase –¥–ª—è –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–π –¥–æ—Å—Ç–∞–≤–∫–∏
                            createFirebaseNotification(latestMessage, chatName, notificationType);
                            
                            // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–∞–π–º—Å—Ç–∞–º–ø
                            lastMessageTimestamp = latestMessage.timestamp;
                        }
                    }
                });
            } catch (error) {
                console.error('[CheckMessages] Error:', error);
            }
        }

// –°–æ–∑–¥–∞–Ω–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤ Firebase –¥–ª—è –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–π –¥–æ—Å—Ç–∞–≤–∫–∏
async function createFirebaseNotification(message, chatName, type) {
    if (!currentUser) return;
    
    try {
        const notificationsRef = database.ref('users/' + encodeURIComponent(currentUser) + '/notifications');
        await notificationsRef.push({
            type: type,
            from: message.sender,
            chatName: chatName,
            text: message.text,
            timestamp: Date.now(),
            read: false
        });
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤ Firebase:', error);
    }
}
        
        async function checkForGroupInvites() {
            if (!currentUser || !isOnline) return;
            
            try {
                const snapshot = await database.ref('groups').once('value');
                const allGroups = snapshot.val();
                if (!allGroups) return;
                
                Object.keys(allGroups).forEach(groupId => {
                    const group = allGroups[groupId];
                    
                    // Notify if added to new group and (tab hidden OR not currently viewing that group)
                    const shouldNotify = document.hidden || currentChat !== groupId;
                    
                    if (group.participants && group.participants.includes(currentUser) && 
                        !groups.some(g => g.id === groupId) && shouldNotify) {
                        
                        showBrowserNotification('Twin Messenger', `–í–∞—Å –¥–æ–±–∞–≤–∏–ª–∏ –≤ –≥—Ä—É–ø–ø—É "${group.name}"`);
                        
                        loadGroups();
                    }
                });
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–π –≤ –≥—Ä—É–ø–ø—ã:', error);
            }
        }
        
        async function checkForChannelUpdates() {
            if (!currentUser || !isOnline) return;
            
            try {
                const snapshot = await database.ref('channels').once('value');
                const allChannels = snapshot.val();
                if (!allChannels) return;
                
                Object.keys(allChannels).forEach(channelId => {
                    const channel = allChannels[channelId];
                    
                    if (subscribedChannels.includes(channelId) && channel.messages) {
                        const messages = Object.keys(channel.messages).map(key => ({
                            id: key,
                            ...channel.messages[key]
                        }));
                        
                        const latestMessage = messages
                            .filter(msg => msg.text && msg.sender && msg.timestamp)
                            .sort((a, b) => b.timestamp - a.timestamp)[0];
                        
                        if (!latestMessage) return;
                        
                        const messageId = latestMessage.id;
                        const isNewMessage = latestMessage.timestamp > lastMessageTimestamp;
                        const isNotFromMe = latestMessage.sender !== currentUser;
                        const notAlreadyNotified = !notifiedMessageIds.has(messageId);
                        // Notify if tab hidden OR different channel is open
                        const shouldNotify = document.hidden || currentChat !== channelId;
                        
                        if (isNewMessage && isNotFromMe && notAlreadyNotified && shouldNotify) {
                            
                            // Mark this message as notified
                            notifiedMessageIds.add(messageId);
                            
                            // Limit the size of the set to prevent memory leaks
                            if (notifiedMessageIds.size > 100) {
                                const firstId = notifiedMessageIds.values().next().value;
                                notifiedMessageIds.delete(firstId);
                            }
                            
                            showBrowserNotification(
                                `–ù–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ –∫–∞–Ω–∞–ª–µ "${channel.name}"`,
                                latestMessage.text
                            );
                            
                            lastMessageTimestamp = latestMessage.timestamp;
                        }
                    }
                });
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π –∫–∞–Ω–∞–ª–æ–≤:', error);
            }
        }
        
        function truncate(text, length) {
            return text.length > length ? text.substring(0, length) + '...' : text;
        }
        
        function toggleSidebar() {
            sidebar.classList.toggle('active');
            sidebarOverlay.classList.toggle('active');
        }
        
        function openSidebar() {
            sidebar.classList.add('active');
            sidebarOverlay.classList.add('active');
        }
        
        function closeSidebar() {
            sidebar.classList.remove('active');
            sidebarOverlay.classList.remove('active');
        }
        
        function handleResize() {
            if (window.innerWidth > 768) {
                sidebar.classList.remove('active');
            }
            
            if (window.innerWidth <= 768 && currentChat) {
                adjustMessageInput();
                scrollToBottom();
            }
        }
        
        function adjustMessageInput() {
            if (window.innerWidth <= 768 && currentChat) {
                const headerHeight = document.querySelector('.chat-header').offsetHeight;
                const inputHeight = document.querySelector('.message-input').offsetHeight;
                const windowHeight = window.innerHeight;
                
                chatMessages.style.height = `${windowHeight - headerHeight - inputHeight}px`;
                chatMessages.style.overflowY = 'auto';
            }
        }
        
        function switchTab(tab) {
            activeTab = tab;
            
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            
            if (tab === 'chats') {
                chatsTab.classList.add('active');
                loadRecentChats();
            } else if (tab === 'users') {
                usersTab.classList.add('active');
                loadUsers();
            } else if (tab === 'channels') {
                channelsTab.classList.add('active');
                loadChannels();
            }
        }
        
        function toggleTheme() {
            if (themeToggle.checked) {
                document.body.classList.add('dark-theme');
                localStorage.setItem('dark_theme', 'true');
            } else {
                document.body.classList.remove('dark-theme');
                localStorage.setItem('dark_theme', 'false');
            }
        }
        
        async function openSettings() {
            newUsernameInput.value = currentUser || '';
            
            document.querySelectorAll('.emoji-option').forEach(opt => {
                opt.classList.remove('selected');
                if (opt.dataset.emoji === userEmoji) {
                    opt.classList.add('selected');
                }
            });
            
            await loadBlockedUsers();
            displayBlockedUsers();
            
            settingsModal.classList.add('active');
            settingsMenu.classList.remove('active');
        }
        
        function closeSettings() {
            settingsModal.classList.remove('active');
        }
        
        async function saveSettings() {
            const newUsername = newUsernameInput.value.trim();
            
            if (!newUsername) {
                showNotification('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –Ω–æ–≤—ã–π –Ω–∏–∫–Ω–µ–π–º');
                return;
            }
            
            if (newUsername === currentUser && userEmoji === userEmojiEl.textContent) {
                showNotification('–ò–∑–º–µ–Ω–µ–Ω–∏–π –Ω–µ—Ç');
                closeSettings();
                return;
            }
            
            try {
                if (newUsername !== currentUser) {
                    const userRef = database.ref('users/' + encodeURIComponent(newUsername));
                    const snapshot = await userRef.once('value');
                    
                    if (snapshot.exists()) {
                        showNotification('–≠—Ç–æ—Ç –Ω–∏–∫–Ω–µ–π–º —É–∂–µ –∑–∞–Ω—è—Ç');
                        return;
                    }
                    
                    await database.ref('users/' + encodeURIComponent(currentUser)).remove();
                    await database.ref('users/' + encodeURIComponent(newUsername)).set({
                        nickname: newUsername,
                        emoji: userEmoji,
                        online: true,
                        lastSeen: Date.now(),
                        blockedUsers: blockedUsers,
                        subscribedChannels: subscribedChannels
                    });
                    
                    localStorage.setItem('messenger_user', newUsername);
                    currentUser = newUsername;
                    currentUserEl.querySelector('span:last-child').textContent = newUsername;
                } else {
                    await database.ref('users/' + encodeURIComponent(currentUser)).update({
                        emoji: userEmoji,
                        blockedUsers: blockedUsers,
                        subscribedChannels: subscribedChannels
                    });
                }
                
                userEmojiEl.textContent = userEmoji;
                showNotification('–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã');
                closeSettings();
                
                if (activeTab === 'chats') {
                    loadRecentChats();
                } else if (activeTab === 'users') {
                    loadUsers();
                } else if (activeTab === 'channels') {
                    loadChannels();
                }
                
            } catch (error) {
                showNotification('–û—à–∏–±–∫–∞: ' + error.message);
            }
        }
        
        async function loadUserData() {
            try {
                const snapshot = await database.ref('users/' + encodeURIComponent(currentUser)).once('value');
                const userData = snapshot.val();
                if (userData) {
                    currentUserData = userData;
                    if (userData.emoji) {
                        userEmoji = userData.emoji;
                        userEmojiEl.textContent = userEmoji;
                    }
                    if (userData.blockedUsers) {
                        blockedUsers = userData.blockedUsers;
                    }
                    if (userData.subscribedChannels) {
                        subscribedChannels = userData.subscribedChannels;
                    }
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:', error);
            }
        }
        
        async function addUserToFirebase(username, emoji) {
            // –≠—Ç–∞ —Ñ—É–Ω–∫—Ü–∏—è –±–æ–ª—å—à–µ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –Ω–∞–ø—Ä—è–º—É—é, 
            // —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —Ç–µ–ø–µ—Ä—å –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç —á–µ—Ä–µ–∑ requestUsername
            try {
                await database.ref('users/' + encodeURIComponent(username)).set({
                    username: username,
                    name: username,
                    emoji: emoji,
                    online: true,
                    lastSeen: Date.now(),
                    blockedUsers: [],
                    subscribedChannels: [],
                    recentChats: []
                });
            } catch (error) {
                showNotification('–û—à–∏–±–∫–∞: ' + error.message);
            }
        }
        
        async function updateUserStatus(online) {
    if (!currentUser) return;
    
    try {
        await database.ref('users/' + encodeURIComponent(currentUser)).update({
            online: online,
            lastSeen: Date.now()
        });
        
        // –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ —Å–º–µ–Ω–µ —Å—Ç–∞—Ç—É—Å–∞
        if (online) {
            showNotification('üü¢ –í—ã –≤ —Å–µ—Ç–∏');
        } else {
            showNotification('üî¥ –í—ã –Ω–µ –≤ —Å–µ—Ç–∏');
        }
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞:', error);
    }
}
        
        async function loadRecentChats() {
            try {
                searchResults.innerHTML = '<div style="text-align: center; padding: 10px; color: var(--text-light);">–ó–∞–≥—Ä—É–∑–∫–∞ —á–∞—Ç–æ–≤...</div>';
                
                const snapshot = await database.ref('messages').once('value');
                const allChats = snapshot.val();
                const recentChats = [];
                const addedUsernames = new Set();
                
                // –°–Ω–∞—á–∞–ª–∞ –¥–æ–±–∞–≤–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏–∑ recentChats (—Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤)
                if (currentUserData && currentUserData.recentChats) {
                    for (const chat of currentUserData.recentChats) {
                        if (chat.username && !addedUsernames.has(chat.username)) {
                            addedUsernames.add(chat.username);
                            
                            // –ü–æ–ª—É—á–∞–µ–º –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                            const userSnapshot = await database.ref('users/' + encodeURIComponent(chat.username)).once('value');
                            const userData = userSnapshot.val();
                            
                            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —Å–æ–æ–±—â–µ–Ω–∏—è —Å —ç—Ç–∏–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º
                            const chatId = getChatId(currentUser, chat.username);
                            let lastMessageText = '–ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π';
                            let lastTimestamp = chat.addedAt || Date.now();
                            let lastSender = null;
                            
                            if (allChats && allChats[chatId]) {
                                const messages = allChats[chatId];
                                const messagesArray = Object.keys(messages).map(key => ({
                                    id: key,
                                    ...messages[key]
                                }));
                                
                                const lastMessage = messagesArray
                                    .filter(msg => msg.text && msg.sender && msg.timestamp)
                                    .sort((a, b) => b.timestamp - a.timestamp)[0];
                                
                                if (lastMessage) {
                                    lastMessageText = lastMessage.text;
                                    lastTimestamp = lastMessage.timestamp;
                                    lastSender = lastMessage.sender;
                                }
                            }
                            
                            recentChats.push({
                                id: chatId,
                                user: chat.username,
                                name: userData ? userData.name : chat.name,
                                emoji: userData ? userData.emoji : (chat.emoji || 'üòä'),
                                lastMessage: lastMessageText,
                                timestamp: lastTimestamp,
                                sender: lastSender,
                                type: 'user'
                            });
                        }
                    }
                }
                
                // –ó–∞—Ç–µ–º –¥–æ–±–∞–≤–ª—è–µ–º —á–∞—Ç—ã —Å —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏ (–∫–æ—Ç–æ—Ä—ã—Ö –µ—â–µ –Ω–µ—Ç –≤ —Å–ø–∏—Å–∫–µ)
                if (allChats) {
                    Object.keys(allChats).forEach(chatId => {
                        if (chatId.includes(currentUser) && !chatId.startsWith('group_') && !chatId.startsWith('channel_')) {
                            const messages = allChats[chatId];
                            
                            const messagesArray = Object.keys(messages).map(key => ({
                                id: key,
                                ...messages[key]
                            }));
                            
                            const lastMessage = messagesArray
                                .filter(msg => msg.text && msg.sender && msg.timestamp)
                                .sort((a, b) => b.timestamp - a.timestamp)[0];
                            
                            if (lastMessage) {
                                const otherUser = chatId.replace(currentUser, '').replace('_', '');
                                
                                if (!addedUsernames.has(otherUser)) {
                                    addedUsernames.add(otherUser);
                                    recentChats.push({
                                        id: chatId,
                                        user: otherUser,
                                        lastMessage: lastMessage.text,
                                        timestamp: lastMessage.timestamp,
                                        sender: lastMessage.sender,
                                        type: 'user'
                                    });
                                }
                            }
                        }
                    });
                }
                
                for (const group of groups) {
                    const groupId = group.id;
                    const groupMessages = allChats && allChats[groupId];
                    
                    if (groupMessages) {
                        const messagesArray = Object.keys(groupMessages).map(key => ({
                            id: key,
                            ...groupMessages[key]
                        }));
                        
                        const lastMessage = messagesArray
                            .filter(msg => msg.text && msg.sender && msg.timestamp)
                            .sort((a, b) => b.timestamp - a.timestamp)[0];
                        
                        if (lastMessage) {
                            recentChats.push({
                                id: groupId,
                                name: group.name,
                                lastMessage: lastMessage.text,
                                timestamp: lastMessage.timestamp,
                                sender: lastMessage.sender,
                                type: 'group'
                            });
                        }
                    } else {
                        recentChats.push({
                            id: groupId,
                            name: group.name,
                            lastMessage: '–ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π',
                            timestamp: group.createdAt,
                            sender: null,
                            type: 'group'
                        });
                    }
                }
                
                for (const channel of channels) {
                    const channelId = channel.id;
                    
                    // Only show subscribed channels in Chats tab
                    if (!subscribedChannels.includes(channelId)) {
                        continue;
                    }
                    
                    const channelMessages = allChats && allChats[channelId];
                    
                    if (channelMessages) {
                        const messagesArray = Object.keys(channelMessages).map(key => ({
                            id: key,
                            ...channelMessages[key]
                        }));
                        
                        const lastMessage = messagesArray
                            .filter(msg => msg.text && msg.sender && msg.timestamp)
                            .sort((a, b) => b.timestamp - a.timestamp)[0];
                        
                        if (lastMessage) {
                            recentChats.push({
                                id: channelId,
                                name: channel.name,
                                lastMessage: lastMessage.text,
                                timestamp: lastMessage.timestamp,
                                sender: lastMessage.sender,
                                type: 'channel'
                            });
                        }
                    } else {
                        recentChats.push({
                            id: channelId,
                            name: channel.name,
                            lastMessage: '–ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π',
                            timestamp: channel.createdAt,
                            sender: null,
                            type: 'channel'
                        });
                    }
                }
                
                recentChats.sort((a, b) => b.timestamp - a.timestamp);
                
                displayRecentChats(recentChats);
            } catch (error) {
                showNotification('–û—à–∏–±–∫–∞: ' + error.message);
                searchResults.innerHTML = '<div class="user-item">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —á–∞—Ç–æ–≤</div>';
            }
        }
        
        async function displayRecentChats(chats) {
            searchResults.innerHTML = '';
            
            if (chats.length === 0) {
                searchResults.innerHTML = '<div class="user-item" style="text-align: center; color: var(--text-light);">–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç —á–∞—Ç–æ–≤.<br>–ù–∞–π–¥–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —á–µ—Ä–µ–∑ –ø–æ–∏—Å–∫ –≤–æ –≤–∫–ª–∞–¥–∫–µ "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏"</div>';
                return;
            }
            
            // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –¥–ª—è —á–∞—Ç–æ–≤ –±–µ–∑ –¥–∞–Ω–Ω—ã—Ö
            const usersPromises = chats
                .filter(chat => chat.type === 'user' && !chat.name)
                .map(async chat => {
                    const snapshot = await database.ref('users/' + encodeURIComponent(chat.user)).once('value');
                    const userData = snapshot.val();
                    return {
                        ...chat,
                        userData: userData || { name: chat.user, username: chat.user, online: false, emoji: 'üòä' }
                    };
                });
            
            const chatsWithUserData = await Promise.all(usersPromises);
            
            // –û–±—ä–µ–¥–∏–Ω—è–µ–º —á–∞—Ç—ã —Å –¥–∞–Ω–Ω—ã–º–∏
            const allChats = chats.map(chat => {
                if (chat.type === 'user' && !chat.name) {
                    const chatWithData = chatsWithUserData.find(c => c.id === chat.id);
                    return chatWithData || chat;
                }
                return chat;
            });
            
            allChats.forEach(chat => {
                const userItem = document.createElement('div');
                userItem.className = 'user-item';
                
                const messageDate = new Date(chat.timestamp);
                const timeString = messageDate.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                
                let lastMessageText = chat.lastMessage;
                if (chat.type === 'user') {
                    if (chat.sender === currentUser) {
                        lastMessageText = `–í—ã: ${lastMessageText}`;
                    }
                } else {
                    if (chat.sender) {
                        lastMessageText = `${chat.sender}: ${lastMessageText}`;
                    }
                }
                
                let avatar, name, emoji, username;
                if (chat.type === 'user') {
                    const displayName = chat.name || (chat.userData ? chat.userData.name : chat.user) || 'Unknown';
                    const displayEmoji = chat.emoji || (chat.userData ? chat.userData.emoji : 'üòä');
                    const displayUsername = chat.user || (chat.userData ? chat.userData.username : '');
                    avatar = displayName.charAt(0).toUpperCase();
                    name = displayName;
                    emoji = displayEmoji;
                    username = displayUsername;
                } else if (chat.type === 'group') {
                    avatar = 'üë•';
                    name = chat.name;
                    emoji = 'üë•';
                } else { // channel
                    const channel = channels.find(c => c.id === chat.id);
                    if (channel && channel.icons && channel.icons.length > 0) {
                        avatar = getChannelIconHtml(channel);
                    } else {
                        avatar = 'üì¢';
                    }
                    name = chat.name;
                    emoji = 'üì¢';
                }
                
                userItem.innerHTML = `
                    <div class="user-avatar">${avatar}</div>
                    <div class="user-info">
                        <h3>
                            <span class="user-emoji-small">${emoji}</span>
                            <span>${escapeHtml(name)}</span>
                        </h3>
                        ${chat.type === 'user' && username ? `<p style="font-size: 0.75rem; color: var(--text-light);">@${username}</p>` : ''}
                        <div class="chat-preview">
                            <div class="last-message">${escapeHtml(lastMessageText)}</div>
                            <div class="last-time">${formatLastSeen(chat.timestamp)}</div>
                        </div>
                    </div>
                    <div class="chat-actions">
                        <button class="chat-action-btn delete-chat-btn" data-chat-id="${chat.id}" data-chat-type="${chat.type}" title="–£–¥–∞–ª–∏—Ç—å —á–∞—Ç">üóëÔ∏è</button>
                    </div>
                `;
                
                userItem.addEventListener('click', (e) => {
                    if (e.target.classList.contains('delete-chat-btn')) {
                        return;
                    }
                    
                    if (chat.type === 'user') {
                        const displayName = chat.name || (chat.userData ? chat.userData.name : chat.user);
                        const displayEmoji = chat.emoji || (chat.userData ? chat.userData.emoji : 'üòä');
                        openChat(chat.user, displayEmoji, displayName);
                    } else if (chat.type === 'group') {
                        openGroupChat(chat.id, chat.name);
                    } else if (chat.type === 'channel') {
                        openChannelChat(chat.id, chat.name);
                    }
                });
                
                const deleteBtn = userItem.querySelector('.delete-chat-btn');
                deleteBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    
                    let confirmMessage = '';
                    if (chat.type === 'group') {
                        const group = groups.find(g => g.id === chat.id);
                        if (group && group.admin === currentUser) {
                            confirmMessage = '–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç—É –≥—Ä—É–ø–ø—É? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–æ–±—Ä–∞—Ç–∏–º–æ.';
                        } else {
                            confirmMessage = '–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –ø–æ–∫–∏–Ω—É—Ç—å —ç—Ç—É –≥—Ä—É–ø–ø—É?';
                        }
                    } else if (chat.type === 'channel') {
                        const channel = channels.find(c => c.id === chat.id);
                        if (channel && channel.creator === currentUser) {
                            confirmMessage = '–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç –∫–∞–Ω–∞–ª? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–æ–±—Ä–∞—Ç–∏–º–æ.';
                        } else {
                            confirmMessage = '–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –æ—Ç–ø–∏—Å–∞—Ç—å—Å—è –æ—Ç —ç—Ç–æ–≥–æ –∫–∞–Ω–∞–ª–∞?';
                        }
                    } else {
                        confirmMessage = '–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç —á–∞—Ç? –í—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è –±—É–¥—É—Ç —É–¥–∞–ª–µ–Ω—ã.';
                    }
                    
                    if (confirm(confirmMessage)) {
                        deleteChatById(chat.id, chat.type);
                    }
                });
                
                searchResults.appendChild(userItem);
            });
        }
        
        async function deleteChatById(chatId, type) {
            try {
                if (type === 'group') {
                    const groupSnapshot = await database.ref('groups/' + chatId).once('value');
                    const group = groupSnapshot.val();
                    
                    if (group && group.admin === currentUser) {
                        await database.ref('groups/' + chatId).remove();
                        await database.ref('messages/' + chatId).remove();
                        showNotification('–ì—Ä—É–ø–ø–∞ —É–¥–∞–ª–µ–Ω–∞');
                    } else if (group && group.participants) {
                        const updatedParticipants = group.participants.filter(p => p !== currentUser);
                        await database.ref('groups/' + chatId).update({
                            participants: updatedParticipants
                        });
                        showNotification('–í—ã –ø–æ–∫–∏–Ω—É–ª–∏ –≥—Ä—É–ø–ø—É');
                    } else {
                        showNotification('–ì—Ä—É–ø–ø–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞');
                    }
                    
                    await loadGroups();
                } else if (type === 'channel') {
                    const channelSnapshot = await database.ref('channels/' + chatId).once('value');
                    const channel = channelSnapshot.val();
                    
                    if (channel && channel.creator === currentUser) {
                        await database.ref('channels/' + chatId).remove();
                        await database.ref('messages/' + chatId).remove();
                        showNotification('–ö–∞–Ω–∞–ª —É–¥–∞–ª–µ–Ω');
                    } else {
                        await unsubscribeFromChannel(chatId);
                        showNotification('–í—ã –æ—Ç–ø–∏—Å–∞–ª–∏—Å—å –æ—Ç –∫–∞–Ω–∞–ª–∞');
                    }
                    
                    await loadChannels();
                } else {
                    // –£–¥–∞–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è
                    await database.ref('messages/' + chatId).remove();
                    
                    // –£–¥–∞–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ recentChats
                    const otherUser = chatId.replace(currentUser, '').replace('_', '');
                    const userRef = database.ref('users/' + encodeURIComponent(currentUser));
                    const snapshot = await userRef.once('value');
                    const userData = snapshot.val();
                    
                    if (userData && userData.recentChats) {
                        const updatedRecentChats = userData.recentChats.filter(chat => chat.username !== otherUser);
                        await userRef.update({ recentChats: updatedRecentChats });
                        currentUserData.recentChats = updatedRecentChats;
                    }
                    
                    showNotification('–ß–∞—Ç —É–¥–∞–ª–µ–Ω');
                }
                
                await loadRecentChats();
            } catch (error) {
                showNotification('–û—à–∏–±–∫–∞: ' + error.message);
            }
        }
        
        async function loadUsers() {
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º AI –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞ –∏ –ø–æ–¥—Å–∫–∞–∑–∫—É –¥–ª—è –ø–æ–∏—Å–∫–∞
            searchResults.innerHTML = '';
            
            // –î–æ–±–∞–≤–ª—è–µ–º AI –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞ –≤ –Ω–∞—á–∞–ª–æ —Å–ø–∏—Å–∫–∞
            const aiAssistantItem = document.createElement('div');
            aiAssistantItem.className = 'user-item';
            aiAssistantItem.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
            aiAssistantItem.style.color = 'white';
            aiAssistantItem.style.marginBottom = '10px';
            aiAssistantItem.style.borderRadius = '8px';
            aiAssistantItem.innerHTML = `
                <div class="user-avatar" style="background: white; color: #667eea;">ü§ñ</div>
                <div class="user-info">
                    <h3 style="color: white;">
                        <span class="user-emoji-small">ü§ñ</span>
                        <span>AI –ê—Å—Å–∏—Å—Ç–µ–Ω—Ç</span>
                        <span style="background: #2ecc71; color: white; font-size: 0.7rem; padding: 2px 6px; border-radius: 10px; margin-left: 8px;">–û–Ω–ª–∞–π–Ω</span>
                    </h3>
                    <p style="color: rgba(255,255,255,0.8);">@ai_assistant</p>
                    <p style="color: rgba(255,255,255,0.9);">–ó–∞–¥–∞–π –º–Ω–µ –ª—é–±–æ–π –≤–æ–ø—Ä–æ—Å!</p>
                </div>
            `;
            aiAssistantItem.addEventListener('click', () => openAIAssistantChat());
            searchResults.appendChild(aiAssistantItem);
            
            // –î–æ–±–∞–≤–ª—è–µ–º —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å
            const divider = document.createElement('div');
            divider.style.padding = '10px 15px';
            divider.style.color = 'var(--text-light)';
            divider.style.fontSize = '0.85rem';
            divider.style.borderBottom = '1px solid var(--border-color)';
            divider.innerHTML = 'üîç –í–≤–µ–¥–∏—Ç–µ —é–∑–µ—Ä–Ω–µ–π–º –¥–ª—è –ø–æ–∏—Å–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π';
            searchResults.appendChild(divider);
        }
        
        // –û—Ç–∫—Ä—ã—Ç—å —á–∞—Ç —Å AI –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–æ–º
        function openAIAssistantChat() {
            currentChat = 'ai_assistant';
            currentChatType = 'ai';
            currentGroup = null;
            currentChannel = null;
            
            emptyState.style.display = 'none';
            chatHeader.style.display = 'flex';
            chatMessages.style.display = 'block';
            messageInputContainer.style.display = 'flex';
            
            chatAvatar.textContent = 'ü§ñ';
            chatUserName.innerHTML = `
                <span class="user-emoji-small">ü§ñ</span>
                <span>AI –ê—Å—Å–∏—Å—Ç–µ–Ω—Ç</span>
                <span style="background: #2ecc71; color: white; font-size: 0.7rem; padding: 2px 6px; border-radius: 10px; margin-left: 8px;">AI</span>
            `;
            
            // –°–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫–∏ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –∏ —É–¥–∞–ª–µ–Ω–∏—è –¥–ª—è AI, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –æ—á–∏—Å—Ç–∫–∏
            blockUserBtn.style.display = 'none';
            deleteChatBtn.style.display = 'none';
            groupSettingsBtn.style.display = 'none';
            channelSettingsBtn.style.display = 'none';
            
            // –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É –æ—á–∏—Å—Ç–∫–∏ –∏—Å—Ç–æ—Ä–∏–∏ –µ—Å–ª–∏ –µ—ë –µ—â—ë –Ω–µ—Ç
            let clearHistoryBtn = document.getElementById('clear-history-btn');
            if (!clearHistoryBtn) {
                clearHistoryBtn = document.createElement('button');
                clearHistoryBtn.id = 'clear-history-btn';
                clearHistoryBtn.className = 'chat-header-btn';
                clearHistoryBtn.title = '–û—á–∏—Å—Ç–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é';
                clearHistoryBtn.innerHTML = 'üóëÔ∏è';
                clearHistoryBtn.style.color = '#e74c3c';
                chatHeader.querySelector('.chat-header-actions').appendChild(clearHistoryBtn);
            }
            clearHistoryBtn.style.display = 'block';
            clearHistoryBtn.onclick = clearAIChatHistory;
            
            if (window.innerWidth <= 768) {
                sidebar.classList.remove('active');
            }
            
            loadAIMessages();
            
            // –î–æ–±–∞–≤–ª—è–µ–º –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –µ—Å–ª–∏ —á–∞—Ç –ø—É—Å—Ç–æ–π
            const chatId = getChatId(currentUser, 'ai_assistant');
            database.ref('messages/' + chatId).once('value').then(snapshot => {
                if (!snapshot.exists()) {
                    const welcomeMessage = {
                        sender: 'ai_assistant',
                        text: '–ü—Ä–∏–≤–µ—Ç! –Ø AI –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç. –Ø –º–æ–≥—É –æ—Ç–≤–µ—Ç–∏—Ç—å –Ω–∞ —Ç–≤–æ–∏ –≤–æ–ø—Ä–æ—Å—ã, –ø–æ–º–æ—á—å —Å –ø–µ—Ä–µ–≤–æ–¥–æ–º, –Ω–∞–ø–∏—Å–∞—Ç—å —Ç–µ–∫—Å—Ç –∏–ª–∏ –ø—Ä–æ—Å—Ç–æ –ø–æ–±–æ–ª—Ç–∞—Ç—å. –ß–µ–º –º–æ–≥—É –ø–æ–º–æ—á—å?',
                        timestamp: Date.now()
                    };
                    database.ref('messages/' + chatId).push(welcomeMessage);
                    loadAIMessages();
                }
            });
            
            messageText.focus();
        }
        
        // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π AI –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞
        async function loadAIMessages() {
            if (!currentChat || currentChatType !== 'ai') return;
            
            try {
                const chatId = getChatId(currentUser, 'ai_assistant');
                const snapshot = await database.ref('messages/' + chatId).once('value');
                const messages = snapshot.val();
                displayMessages(messages, true);
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π AI:', error);
            }
        }
        
        // –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è AI –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç—É —á–µ—Ä–µ–∑ OpenRouter
        async function sendMessageToAI(userMessage) {
            const chatId = getChatId(currentUser, 'ai_assistant');
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä "–ø–µ—á–∞—Ç–∞–µ—Ç"
            showNotification('AI –¥—É–º–∞–µ—Ç...');
            
            try {
                // –ò—Å–ø–æ–ª—å–∑—É–µ–º OpenRouter API —Å –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω—ã–º –∫–ª—é—á–æ–º
                const apiKey = getAPIKey();
                const response = await fetch('https://openrouter.ai/api/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + apiKey,
                        'HTTP-Referer': window.location.origin,
                        'X-Title': 'Twin Messenger AI'
                    },
                    body: JSON.stringify({
                        model: 'arcee-ai/trinity-mini:free',
                        messages: [
                            {
                                role: 'system',
                                content: 'You are a helpful AI assistant in a chat messenger. Respond in the same language as the user (Russian or English). Be friendly and concise.'
                            },
                            {
                                role: 'user',
                                content: userMessage
                            }
                        ],
                        max_tokens: 1000,
                        temperature: 0.7
                    })
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error?.message || '–û—à–∏–±–∫–∞ API');
                }
                
                const data = await response.json();
                console.log('OpenRouter response:', data);
                
                let aiResponse;
                if (data.choices && data.choices[0] && data.choices[0].message) {
                    aiResponse = data.choices[0].message.content;
                } else if (data.choices && data.choices[0] && data.choices[0].text) {
                    aiResponse = data.choices[0].text;
                } else {
                    aiResponse = '–ò–∑–≤–∏–Ω–∏, —è –Ω–µ —Å–º–æ–≥ –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å —Ç–≤–æ–π –∑–∞–ø—Ä–æ—Å.';
                }
                
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ç–≤–µ—Ç AI
                const aiMessage = {
                    sender: 'ai_assistant',
                    text: aiResponse.trim(),
                    timestamp: Date.now()
                };
                
                await database.ref('messages/' + chatId).push(aiMessage);
                loadAIMessages();
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ AI:', error);
                // Fallback –æ—Ç–≤–µ—Ç –µ—Å–ª–∏ API –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω
                const fallbackMessage = {
                    sender: 'ai_assistant',
                    text: getFallbackResponse(userMessage),
                    timestamp: Date.now()
                };
                await database.ref('messages/' + chatId).push(fallbackMessage);
                loadAIMessages();
            }
        }
        
        // –û—á–∏—Å—Ç–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏ —á–∞—Ç–∞ —Å AI
        async function clearAIChatHistory() {
            if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –æ—á–∏—Å—Ç–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é –ø–µ—Ä–µ–ø–∏—Å–∫–∏ —Å AI?')) return;
            
            try {
                const chatId = getChatId(currentUser, 'ai_assistant');
                await database.ref('messages/' + chatId).remove();
                
                // –î–æ–±–∞–≤–ª—è–µ–º –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –∑–∞–Ω–æ–≤–æ
                const welcomeMessage = {
                    sender: 'ai_assistant',
                    text: '–ü—Ä–∏–≤–µ—Ç! –Ø AI –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç. –Ø –º–æ–≥—É –æ—Ç–≤–µ—Ç–∏—Ç—å –Ω–∞ —Ç–≤–æ–∏ –≤–æ–ø—Ä–æ—Å—ã, –ø–æ–º–æ—á—å —Å –ø–µ—Ä–µ–≤–æ–¥–æ–º, –Ω–∞–ø–∏—Å–∞—Ç—å —Ç–µ–∫—Å—Ç –∏–ª–∏ –ø—Ä–æ—Å—Ç–æ –ø–æ–±–æ–ª—Ç–∞—Ç—å. –ß–µ–º –º–æ–≥—É –ø–æ–º–æ—á—å?',
                    timestamp: Date.now()
                };
                await database.ref('messages/' + chatId).push(welcomeMessage);
                
                loadAIMessages();
                showNotification('–ò—Å—Ç–æ—Ä–∏—è –ø–µ—Ä–µ–ø–∏—Å–∫–∏ –æ—á–∏—â–µ–Ω–∞');
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –æ—á–∏—Å—Ç–∫–∏ –∏—Å—Ç–æ—Ä–∏–∏:', error);
                showNotification('–û—à–∏–±–∫–∞: ' + error.message);
            }
        }
        
        // Fallback –æ—Ç–≤–µ—Ç—ã –∫–æ–≥–¥–∞ API –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω
        function getFallbackResponse(message) {
            const lowerMsg = message.toLowerCase();
            
            if (lowerMsg.includes('–ø—Ä–∏–≤–µ—Ç') || lowerMsg.includes('–∑–¥—Ä–∞–≤—Å—Ç–≤—É–π')) {
                return '–ü—Ä–∏–≤–µ—Ç! –ö–∞–∫ –¥–µ–ª–∞?';
            } else if (lowerMsg.includes('–∫–∞–∫ –¥–µ–ª–∞')) {
                return '–£ –º–µ–Ω—è –≤—Å—ë –æ—Ç–ª–∏—á–Ω–æ, —Å–ø–∞—Å–∏–±–æ! –ê —É —Ç–µ–±—è?';
            } else if (lowerMsg.includes('–ø–æ–∫–∞') || lowerMsg.includes('–¥–æ —Å–≤–∏–¥–∞–Ω–∏—è')) {
                return '–î–æ —Å–≤–∏–¥–∞–Ω–∏—è! –•–æ—Ä–æ—à–µ–≥–æ –¥–Ω—è!';
            } else if (lowerMsg.includes('—Å–ø–∞—Å–∏–±–æ')) {
                return '–ü–æ–∂–∞–ª—É–π—Å—Ç–∞! –û–±—Ä–∞—â–∞–π—Å—è –µ—â—ë!';
            } else if (lowerMsg.includes('–ø–æ–º–æ–≥–∏') || lowerMsg.includes('–ø–æ–º–æ—â—å')) {
                return '–Ø –≥–æ—Ç–æ–≤ –ø–æ–º–æ—á—å! –û–ø–∏—à–∏, —á—Ç–æ —Ç–µ–±–µ –Ω—É–∂–Ω–æ.';
            } else if (lowerMsg.includes('—à—É—Ç–∫') || lowerMsg.includes('–∞–Ω–µ–∫–¥–æ—Ç')) {
                return '–ó–Ω–∞–µ—à—å –ø–æ—á–µ–º—É –ø—Ä–æ–≥—Ä–∞–º–º–∏—Å—Ç—ã –ø—É—Ç–∞—é—Ç –•—ç–ª–ª–æ—É–∏–Ω –∏ –†–æ–∂–¥–µ—Å—Ç–≤–æ? –ü–æ—Ç–æ–º—É —á—Ç–æ 31 OCT = 25 DEC!';
            } else if (lowerMsg.includes('–≤—Ä–µ–º—è') || lowerMsg.includes('–¥–∞—Ç–∞')) {
                return '–°–µ–π—á–∞—Å ' + new Date().toLocaleString('ru-RU');
            } else if (lowerMsg.includes('–ø–µ—Ä–µ–≤–µ–¥–∏') || lowerMsg.includes('–ø–µ—Ä–µ–≤–æ–¥')) {
                return '–Ø –º–æ–≥—É –ø–æ–º–æ—á—å —Å –ø–µ—Ä–µ–≤–æ–¥–æ–º! –ù–∞–ø–∏—à–∏ —Ç–µ–∫—Å—Ç, –∫–æ—Ç–æ—Ä—ã–π –Ω—É–∂–Ω–æ –ø–µ—Ä–µ–≤–µ—Å—Ç–∏.';
            } else if (lowerMsg.includes('–∫—Ç–æ —Ç—ã')) {
                return '–Ø AI –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç –≤ —ç—Ç–æ–º –º–µ—Å—Å–µ–Ω–¥–∂–µ—Ä–µ. –Ø –º–æ–≥—É –æ—Ç–≤–µ—á–∞—Ç—å –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã –∏ –ø–æ–º–æ–≥–∞—Ç—å —Å —Ä–∞–∑–Ω—ã–º–∏ –∑–∞–¥–∞—á–∞–º–∏!';
            } else {
                return '–ò–Ω—Ç–µ—Ä–µ—Å–Ω–æ! –†–∞—Å—Å–∫–∞–∂–∏ –ø–æ–¥—Ä–æ–±–Ω–µ–µ, –∏–ª–∏ –∑–∞–¥–∞–π –º–Ω–µ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –≤–æ–ø—Ä–æ—Å.';
            }
        }
        
        // –ü–æ–ª—É—á–µ–Ω–∏–µ API –∫–ª—é—á–∞ (–æ–±—Ñ—É—Å—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã–π)
        function getAPIKey() {
            // –†–∞–∑–±–∏–≤–∞–µ–º –∫–ª—é—á –Ω–∞ —á–∞—Å—Ç–∏ –∏ –¥–µ–∫–æ–¥–∏—Ä—É–µ–º –∏–∑ base64
            const parts = [
                'c2stb3ItdjEtOTY2ZTk0OGNmYmIzMGViOWUxOGMxYjFlN2M4MjBlOWJhYjA5YTA3YjE4OTE3Zjg3N2NhNGRiYzQwMjhlMDgxNg=='
            ];
            return atob(parts[0]);
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞ –¥—Ä—É–≥–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
function trackUserStatus() {
    if (!currentUser) return;
    
    // –°–ª–µ–¥–∏–º –∑–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è–º–∏ —Å—Ç–∞—Ç—É—Å–æ–≤ –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
    database.ref('users').on('child_changed', (snapshot) => {
        const userData = snapshot.val();
        const username = userData ? userData.username : null;
        
        // –ù–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ —Å–µ–±–µ
        if (username && username !== currentUser && userData) {
            if (userData.online) {
                showNotification(`üü¢ ${userData.name || username} –ø–æ—è–≤–∏–ª—Å—è –≤ —Å–µ—Ç–∏`);
            } else {
                showNotification(`üî¥ ${userData.name || username} –≤—ã—à–µ–ª –∏–∑ —Å–µ—Ç–∏`);
            }
        }
    });
}
        
        function displayUsers(users) {
            searchResults.innerHTML = '';
            
            if (!users) {
                searchResults.innerHTML = '<div class="user-item">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</div>';
                return;
            }
            
            Object.keys(users).forEach(key => {
                const user = users[key];
                if (key !== currentUser && user && user.username) {
                    const isBlocked = blockedUsers.includes(key);
                    
                    const userItem = document.createElement('div');
                    userItem.className = 'user-item';
                    userItem.innerHTML = `
                        <div class="user-avatar">${(user.name || user.username).charAt(0).toUpperCase()}</div>
                        <div class="user-info">
                            <h3>
                                <span class="user-emoji-small">${user.emoji || 'üòä'}</span>
                                <span>${escapeHtml(user.name || user.username)}</span>
                                ${isBlocked ? '<span style="color: var(--danger-color); margin-left: 5px;">(–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω)</span>' : ''}
                            </h3>
                            <p style="font-size: 0.75rem; color: var(--text-light);">@${user.username}</p>
                            <p>${user.online ? '–û–Ω–ª–∞–π–Ω' : formatLastSeen(user.lastSeen)}</p>
                        </div>
                    `;
                    
                    if (!isBlocked) {
                        userItem.addEventListener('click', () => addUserToChatsAndOpen(user));
                    }
                    
                    searchResults.appendChild(userItem);
                }
            });
        }
        
        // –î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ —á–∞—Ç—ã –∏ –æ—Ç–∫—Ä—ã—Ç—å —á–∞—Ç
        async function addUserToChatsAndOpen(user) {
            if (!currentUser || !user) return;
            
            // –î–æ–±–∞–≤–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ —Å–ø–∏—Å–æ–∫ –Ω–µ–¥–∞–≤–Ω–∏—Ö —á–∞—Ç–æ–≤
            try {
                const userRef = database.ref('users/' + encodeURIComponent(currentUser));
                const snapshot = await userRef.once('value');
                const userData = snapshot.val();
                
                let recentChats = userData.recentChats || [];
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —É–∂–µ —ç—Ç–æ—Ç —á–∞—Ç
                const existingIndex = recentChats.findIndex(chat => chat.username === user.username);
                if (existingIndex === -1) {
                    recentChats.push({
                        username: user.username,
                        name: user.name,
                        emoji: user.emoji || 'üòä',
                        addedAt: Date.now()
                    });
                    
                    await userRef.update({ recentChats: recentChats });
                }
                
                // –û—Ç–∫—Ä—ã–≤–∞–µ–º —á–∞—Ç
                openChat(user.username, user.emoji || 'üòä', user.name);
                
                // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º—Å—è –Ω–∞ –≤–∫–ª–∞–¥–∫—É —á–∞—Ç–æ–≤
                switchTab('chats');
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –≤ —á–∞—Ç—ã:', error);
                openChat(user.username, user.emoji || 'üòä', user.name);
            }
        }
        
        function formatLastSeen(timestamp) {
            if (!timestamp) return '–ë—ã–ª(–∞) –¥–∞–≤–Ω–æ';
            
            const now = Date.now();
            const diff = now - timestamp;
            const minutes = Math.floor(diff / (1000 * 60));
            
            if (minutes < 1) return '–¢–æ–ª—å–∫–æ —á—Ç–æ';
            if (minutes < 60) return `–ë—ã–ª(–∞) ${minutes} –º–∏–Ω –Ω–∞–∑–∞–¥`;
            
            const hours = Math.floor(minutes / 60);
            if (hours < 24) return `–ë—ã–ª(–∞) ${hours} —á –Ω–∞–∑–∞–¥`;
            
            const days = Math.floor(hours / 24);
            return `–ë—ã–ª(–∞) ${days} –¥ –Ω–∞–∑–∞–¥`;
        }
        
        async function handleSearch() {
            const query = searchInput.value.toLowerCase().trim();
            
            if (query === '') {
                if (activeTab === 'chats') {
                    loadRecentChats();
                } else if (activeTab === 'users') {
                    loadUsers();
                } else if (activeTab === 'channels') {
                    loadChannels();
                }
                return;
            }
            
            try {
                if (activeTab === 'users') {
                    // –ü–æ–∏—Å–∫ —Ç–æ–ª—å–∫–æ –ø–æ username (—Ç–æ—á–Ω–æ–µ –∏–ª–∏ —á–∞—Å—Ç–∏—á–Ω–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ)
                    const snapshot = await database.ref('users').once('value');
                    const users = snapshot.val();
                    searchResults.innerHTML = '';
                    
                    if (!users) {
                        searchResults.innerHTML = '<div class="user-item">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</div>';
                        return;
                    }
                    
                    let foundUsers = 0;
                    Object.keys(users).forEach(key => {
                        const user = users[key];
                        // –ò—â–µ–º —Ç–æ–ª—å–∫–æ –ø–æ username (—Ç–æ—á–Ω–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ)
                        if (key !== currentUser && user && user.username && 
                            user.username.toLowerCase() === query) {
                            foundUsers++;
                            const isBlocked = blockedUsers.includes(key);
                            
                            const userItem = document.createElement('div');
                            userItem.className = 'user-item';
                            userItem.innerHTML = `
                                <div class="user-avatar">${(user.name || user.username).charAt(0).toUpperCase()}</div>
                                <div class="user-info">
                                    <h3>
                                        <span class="user-emoji-small">${user.emoji || 'üòä'}</span>
                                        <span>${escapeHtml(user.name || user.username)}</span>
                                        ${isBlocked ? '<span style="color: var(--danger-color); margin-left: 5px;">(–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω)</span>' : ''}
                                    </h3>
                                    <p style="font-size: 0.75rem; color: var(--text-light);">@${user.username}</p>
                                    <p>${user.online ? '–û–Ω–ª–∞–π–Ω' : formatLastSeen(user.lastSeen)}</p>
                                </div>
                            `;
                            
                            if (!isBlocked) {
                                userItem.addEventListener('click', () => addUserToChatsAndOpen(user));
                            }
                            
                            searchResults.appendChild(userItem);
                        }
                    });
                    
                    if (foundUsers === 0) {
                        searchResults.innerHTML = '<div class="user-item" style="text-align: center; color: var(--text-light);">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</div>';
                    }
                } else if (activeTab === 'channels') {
                    const snapshot = await database.ref('channels').once('value');
                    const allChannels = snapshot.val();
                    searchResults.innerHTML = '';
                    
                    if (!allChannels) {
                        searchResults.innerHTML = '<div class="user-item">–ö–∞–Ω–∞–ª—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</div>';
                        return;
                    }
                    
                    Object.keys(allChannels).forEach(channelId => {
                        const channel = allChannels[channelId];
                        if (channel && channel.name && 
                            channel.name.toLowerCase().includes(query)) {
                            
                            const channelItem = document.createElement('div');
                            channelItem.className = 'channel-item';
                            
                            const isSubscribed = subscribedChannels.includes(channelId);
                            const iconHtml = getChannelIconHtml(channel);
                            
                            channelItem.innerHTML = `
                                <div class="channel-icon">${iconHtml}</div>
                                <div class="channel-info">
                                    <h3>${escapeHtml(channel.name)}</h3>
                                    <p>${escapeHtml(channel.description || '–ù–µ—Ç –æ–ø–∏—Å–∞–Ω–∏—è')}</p>
                                    <div class="channel-subscribers">
                                        <span>üë§ ${channel.subscribers ? channel.subscribers.length : 0}</span>
                                    </div>
                                </div>
                                <button class="subscribe-btn ${isSubscribed ? 'subscribed' : ''}" data-channel-id="${channelId}">
                                    ${isSubscribed ? '–û—Ç–ø–∏—Å–∞—Ç—å—Å—è' : '–ü–æ–¥–ø–∏—Å–∞—Ç—å—Å—è'}
                                </button>
                            `;
                            
                            const subscribeBtn = channelItem.querySelector('.subscribe-btn');
                            subscribeBtn.addEventListener('click', (e) => {
                                e.stopPropagation();
                                toggleSubscribe(channelId);
                            });
                            
                            channelItem.addEventListener('click', () => {
                                if (isSubscribed) {
                                    openChannelChat(channelId, channel.name);
                                } else {
                                    showNotification('–ü–æ–¥–ø–∏—à–∏—Ç–µ—Å—å –Ω–∞ –∫–∞–Ω–∞–ª, —á—Ç–æ–±—ã –ø—Ä–æ—Å–º–∞—Ç—Ä–∏–≤–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è');
                                }
                            });
                            
                            searchResults.appendChild(channelItem);
                        }
                    });
                }
            } catch (error) {
                showNotification('–û—à–∏–±–∫–∞: ' + error.message);
            }
        }
        
        function openChat(username, emoji = 'üòä', displayName = null) {
            if (window.innerWidth <= 768) {
                sidebar.classList.remove('active');
                mobileTitle.textContent = displayName || username;
            }
            
            if (currentChat && messageListeners[currentChat]) {
                clearInterval(messageListeners[currentChat]);
            }
            
            currentChat = username;
            currentChatType = 'user';
            currentGroup = null;
            currentChannel = null;
            emptyState.style.display = 'none';
            chatHeader.style.display = 'flex';
            chatMessages.style.display = 'block';
            messageInputContainer.style.display = 'flex';
            
            chatUserEmoji.textContent = emoji;
            chatUserName.querySelector('span:last-child').textContent = displayName || username;
            chatAvatar.textContent = (displayName || username).charAt(0).toUpperCase();
            
            blockUserBtn.style.display = 'block';
            deleteChatBtn.style.display = 'block';
            groupSettingsBtn.style.display = 'none';
            channelSettingsBtn.style.display = 'none';
            
            // –°–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –æ—á–∏—Å—Ç–∫–∏ –∏—Å—Ç–æ—Ä–∏–∏ AI
            const clearHistoryBtn = document.getElementById('clear-history-btn');
            if (clearHistoryBtn) clearHistoryBtn.style.display = 'none';
            
            if (blockedUsers.includes(username)) {
                blockUserBtn.innerHTML = 'üîì';
                blockUserBtn.title = '–†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è';
            } else {
                blockUserBtn.innerHTML = 'üö´';
                blockUserBtn.title = '–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è';
            }
            
            adjustMessageInput();
            
            loadMessages();
            
            messageListeners[username] = setInterval(() => {
                loadMessages();
            }, 3000);
        }
        
        function closeChat() {
            if (window.innerWidth <= 768) {
                emptyState.style.display = 'flex';
                chatHeader.style.display = 'none';
                chatMessages.style.display = 'none';
                messageInputContainer.style.display = 'none';
                mobileTitle.textContent = 'Twin';
                openSidebar();
            } else {
                emptyState.style.display = 'flex';
                chatHeader.style.display = 'none';
                chatMessages.style.display = 'none';
                messageInputContainer.style.display = 'none';
            }
            
            if (currentChat && messageListeners[currentChat]) {
                clearInterval(messageListeners[currentChat]);
                delete messageListeners[currentChat];
            }
            
            currentChat = null;
            currentChatType = null;
            currentGroup = null;
            currentChannel = null;
        }
        
        async function loadMessages() {
            if (!currentChat) return;
            
            // –î–ª—è AI —á–∞—Ç–∞ –∏—Å–ø–æ–ª—å–∑—É–µ–º —Å–ø–µ—Ü–∏–∞–ª—å–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é
            if (currentChatType === 'ai') {
                loadAIMessages();
                return;
            }
            
            try {
                let chatId;
                if (currentChatType === 'group' || currentChatType === 'channel') {
                    chatId = currentChat;
                } else {
                    chatId = getChatId(currentUser, currentChat);
                }
                
                const snapshot = await database.ref('messages/' + chatId).once('value');
                const messages = snapshot.val();
                
                if (currentChatType === 'channel') {
                    displayMessages(messages, false);
                } else {
                    displayMessages(messages, true);
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π:', error);
                showNotification('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π: ' + error.message);
            }
        }
        
        function displayMessages(messages, autoScroll = true) {
            chatMessages.innerHTML = '';
            
            if (!messages) {
                chatMessages.innerHTML = '<div class="message"><div class="message-content">–ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π</div></div>';
                return;
            }
            
            const messagesArray = Object.keys(messages).map(key => ({
                id: key,
                ...messages[key]
            }));
            
            const filteredMessages = messagesArray.filter(message => {
                if (currentChatType === 'user') {
                    return !blockedUsers.includes(message.sender);
                }
                return true;
            });
            
            const sortedMessages = filteredMessages
                .filter(msg => msg.text && msg.sender && msg.timestamp)
                .sort((a, b) => {
                    if (a.timestamp !== b.timestamp) {
                        return a.timestamp - b.timestamp;
                    }
                    return a.id.localeCompare(b.id);
                });
            
            if (sortedMessages.length === 0) {
                chatMessages.innerHTML = '<div class="message"><div class="message-content">–ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π</div></div>';
                return;
            }
            
            let messagesHTML = '';
            let lastDate = null;
            
            sortedMessages.forEach(message => {
                const messageDate = new Date(message.timestamp);
                const dateString = messageDate.toLocaleDateString();
                
                if (dateString !== lastDate) {
                    messagesHTML += `
                        <div style="text-align: center; margin: 15px 0;">
                            <span style="background: var(--message-hover); padding: 5px 10px; border-radius: 10px; font-size: 0.8rem;">
                                ${dateString}
                            </span>
                        </div>
                    `;
                    lastDate = dateString;
                }
                
                const timeString = messageDate.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                const isSent = message.sender === currentUser;
                
                const actionsHTML = isSent ? `
                    <div class="message-actions">
                        <button class="message-action-btn" onclick="editMessage('${message.id}', '${escapeHtml(message.text).replace(/'/g, "\\'")}')">‚úèÔ∏è</button>
                        <button class="message-action-btn" onclick="deleteMessage('${message.id}')">üóëÔ∏è</button>
                    </div>
                ` : '';
                
                let senderName = '';
                if ((currentChatType === 'group' || currentChatType === 'channel') && !isSent) {
                    senderName = `<div style="font-size: 0.8rem; margin-bottom: 3px; color: var(--text-light);">${escapeHtml(message.sender)}</div>`;
                }
                
                const editedMark = message.edited ? ' <span style="font-size: 0.7rem; color: var(--text-light);">(–∏–∑–º–µ–Ω–µ–Ω–æ)</span>' : '';
                
                messagesHTML += `
                    <div class="message ${isSent ? 'sent' : 'received'}">
                        ${senderName}
                        <div class="message-content">${escapeHtml(message.text)}${editedMark}</div>
                        <div class="message-time">${timeString}</div>
                        ${actionsHTML}
                    </div>
                `;
            });
            
            chatMessages.innerHTML = messagesHTML;
            
            if (autoScroll) {
                scrollToBottom();
            }
        }
        
        function escapeHtml(unsafe) {
            if (!unsafe) return '';
            return unsafe
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }
        
        function scrollToBottom() {
            const isScrolledToBottom = chatMessages.scrollHeight - chatMessages.clientHeight <= chatMessages.scrollTop + 50;
            
            if (isScrolledToBottom || !currentChat) {
                chatMessages.scrollTop = chatMessages.scrollHeight;
                
                if (window.innerWidth <= 768) {
                    setTimeout(() => {
                        chatMessages.scrollTop = chatMessages.scrollHeight;
                    }, 100);
                }
            }
        }
        
        async function sendMessage() {
            const text = messageText.value.trim();
            if (!text || !currentChat) return;
            
            // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π –¥–ª—è AI –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞
            if (currentChatType === 'ai') {
                const chatId = getChatId(currentUser, 'ai_assistant');
                
                const message = {
                    sender: currentUser,
                    text: text,
                    timestamp: Date.now()
                };
                
                try {
                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                    await database.ref('messages/' + chatId).push(message);
                    messageText.value = '';
                    loadAIMessages();
                    
                    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –∫ AI
                    await sendMessageToAI(text);
                    
                    messageText.focus();
                    lastMessageTimestamp = message.timestamp;
                } catch (error) {
                    showNotification('–û—à–∏–±–∫–∞: ' + error.message);
                }
                return;
            }
            
            let chatId;
            if (currentChatType === 'group' || currentChatType === 'channel') {
                chatId = currentChat;
            } else {
                chatId = getChatId(currentUser, currentChat);
            }
            
            if (currentChatType === 'channel') {
                const channel = channels.find(c => c.id === chatId);
                if (!channel || channel.creator !== currentUser) {
                    showNotification('–¢–æ–ª—å–∫–æ —Å–æ–∑–¥–∞—Ç–µ–ª—å –∫–∞–Ω–∞–ª–∞ –º–æ–∂–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è');
                    return;
                }
            }
            
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –∫–æ–º–∞–Ω–¥—É –ø–æ–≤—Ç–æ—Ä–∞ #povtors
            const povtorsMatch = text.match(/^#povtors\s+(\d+)\s+(.+)$/i);
            if (povtorsMatch) {
                const count = parseInt(povtorsMatch[1]);
                const messageToRepeat = povtorsMatch[2].trim();
                
                if (count < 1 || count > 100) {
                    showNotification('–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–≤—Ç–æ—Ä–æ–≤ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –æ—Ç 1 –¥–æ 100');
                    return;
                }
                
                if (!messageToRepeat) {
                    showNotification('–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è –ø–æ–≤—Ç–æ—Ä–∞');
                    return;
                }
                
                messageText.value = '';
                await sendRepeatedMessages(chatId, messageToRepeat, count);
                return;
            }
            
            const message = {
                sender: currentUser,
                text: text,
                timestamp: Date.now()
            };
            
            if (currentChatType === 'user') {
                message.receiver = currentChat;
            }
            
            try {
                await database.ref('messages/' + chatId).push(message);
                
                // –°–æ–∑–¥–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –¥–ª—è –ø–æ–ª—É—á–∞—Ç–µ–ª—è(–µ–π)
                await createNotificationForReceiver(text);
                
                messageText.value = '';
                
                loadMessages();
                
                if (activeTab === 'chats') {
                    loadRecentChats();
                }
                
                messageText.focus();
                
                lastMessageTimestamp = message.timestamp;
            } catch (error) {
                showNotification('–û—à–∏–±–∫–∞: ' + error.message);
            }
        }
        
        // –û—Ç–ø—Ä–∞–≤–∫–∞ –ø–æ–≤—Ç–æ—Ä—è—é—â–∏—Ö—Å—è —Å–æ–æ–±—â–µ–Ω–∏–π
        async function sendRepeatedMessages(chatId, text, count) {
            try {
                showNotification(`–û—Ç–ø—Ä–∞–≤–∫–∞ ${count} —Å–æ–æ–±—â–µ–Ω–∏–π...`);
                
                for (let i = 0; i < count; i++) {
                    const message = {
                        sender: currentUser,
                        text: text,
                        timestamp: Date.now() + i // –î–æ–±–∞–≤–ª—è–µ–º i –¥–ª—è —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç–∏ timestamp
                    };
                    
                    if (currentChatType === 'user') {
                        message.receiver = currentChat;
                    }
                    
                    await database.ref('messages/' + chatId).push(message);
                    
                    // –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –º–µ–∂–¥—É —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏ –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏
                    await new Promise(resolve => setTimeout(resolve, 10));
                }
                
                // –°–æ–∑–¥–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –¥–ª—è –ø–æ–ª—É—á–∞—Ç–µ–ª—è(–µ–π)
                await createNotificationForReceiver(`${text} (x${count})`);
                
                loadMessages();
                
                if (activeTab === 'chats') {
                    loadRecentChats();
                }
                
                messageText.focus();
                
                showNotification(`–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ ${count} —Å–æ–æ–±—â–µ–Ω–∏–π`);
            } catch (error) {
                showNotification('–û—à–∏–±–∫–∞: ' + error.message);
            }
        }
        
        // –°–æ–∑–¥–∞–Ω–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –¥–ª—è –ø–æ–ª—É—á–∞—Ç–µ–ª—è
        async function createNotificationForReceiver(text) {
            if (!currentChat) return;
            
            try {
                if (currentChatType === 'user') {
                    // –õ–∏—á–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ - —Å–æ–∑–¥–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –¥–ª—è —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞
                    const receiverNotificationsRef = database.ref('users/' + encodeURIComponent(currentChat) + '/notifications');
                    await receiverNotificationsRef.push({
                        type: 'message',
                        from: currentUser,
                        text: text,
                        timestamp: Date.now(),
                        read: false
                    });
                } else if (currentChatType === 'group') {
                    // –ì—Ä—É–ø–ø–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ - —Å–æ–∑–¥–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –¥–ª—è –≤—Å–µ—Ö —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤
                    if (currentGroup && currentGroup.participants) {
                        for (const participant of currentGroup.participants) {
                            if (participant !== currentUser) {
                                const participantNotificationsRef = database.ref('users/' + encodeURIComponent(participant) + '/notifications');
                                await participantNotificationsRef.push({
                                    type: 'message',
                                    from: currentUser,
                                    groupName: currentGroup.name,
                                    text: text,
                                    timestamp: Date.now(),
                                    read: false
                                });
                            }
                        }
                    }
                } else if (currentChatType === 'channel') {
                    // –ö–∞–Ω–∞–ª - —Å–æ–∑–¥–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –¥–ª—è –≤—Å–µ—Ö –ø–æ–¥–ø–∏—Å—á–∏–∫–æ–≤
                    if (currentChannel && currentChannel.subscribers) {
                        for (const subscriber of currentChannel.subscribers) {
                            if (subscriber !== currentUser) {
                                const subscriberNotificationsRef = database.ref('users/' + encodeURIComponent(subscriber) + '/notifications');
                                await subscriberNotificationsRef.push({
                                    type: 'message',
                                    from: currentUser,
                                    channelName: currentChannel.name,
                                    text: text,
                                    timestamp: Date.now(),
                                    read: false
                                });
                            }
                        }
                    }
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è:', error);
            }
        }
        
        function getChatId(user1, user2) {
            return [user1, user2].sort().join('_');
        }
        
        window.editMessage = function(messageId, text) {
            editingMessageId = messageId;
            editMessageText.value = unescapeHtml(text);
            editMessageModal.classList.add('active');
        };
        
        function closeEditMessage() {
            editMessageModal.classList.remove('active');
            editingMessageId = null;
        }
        
        async function saveEditedMessage() {
            if (!editingMessageId || !currentChat) return;
            
            const newText = editMessageText.value.trim();
            if (!newText) {
                showNotification('–°–æ–æ–±—â–µ–Ω–∏–µ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º');
                return;
            }
            
            try {
                let chatId;
                if (currentChatType === 'group' || currentChatType === 'channel') {
                    chatId = currentChat;
                } else {
                    chatId = getChatId(currentUser, currentChat);
                }
                
                await database.ref('messages/' + chatId + '/' + editingMessageId).update({
                    text: newText,
                    edited: true
                });
                
                closeEditMessage();
                loadMessages();
                
                if (activeTab === 'chats') {
                    loadRecentChats();
                }
                
                showNotification('–°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–æ');
            } catch (error) {
                showNotification('–û—à–∏–±–∫–∞: ' + error.message);
            }
        }
        
        window.deleteMessage = async function(messageId) {
            if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ?')) return;
            
            try {
                let chatId;
                if (currentChatType === 'group' || currentChatType === 'channel') {
                    chatId = currentChat;
                } else {
                    chatId = getChatId(currentUser, currentChat);
                }
                
                await database.ref('messages/' + chatId + '/' + messageId).remove();
                
                loadMessages();
                
                if (activeTab === 'chats') {
                    loadRecentChats();
                }
                
                showNotification('–°–æ–æ–±—â–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–æ');
            } catch (error) {
                showNotification('–û—à–∏–±–∫–∞: ' + error.message);
            }
        };
        
        function unescapeHtml(safe) {
            return safe
                .replace(/&amp;/g, "&")
                .replace(/&lt;/g, "<")
                .replace(/&gt;/g, ">")
                .replace(/&quot;/g, "\"")
                .replace(/&#039;/g, "'");
        }
        
        async function handleLogout() {
            if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –≤—ã–π—Ç–∏?')) {
                await updateUserStatus(false)
                    .finally(() => {
                        localStorage.removeItem('messenger_user');
                        currentUser = null;
                        currentUserData = null;
                        location.reload();
                    });
            }
        }
        
       // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –±—Ä–∞—É–∑–µ—Ä–Ω—ã—Ö —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
function showBrowserNotification(title, message) {
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –ª–∏ –±—Ä–∞—É–∑–µ—Ä —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
    if (!("Notification" in window)) {
        console.log("[Notification] Browser does not support notifications");
        return;
    }
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Ä–∞–∑—Ä–µ—à–µ–Ω—ã –ª–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
    if (Notification.permission !== "granted") {
        console.log("[Notification] Permission not granted:", Notification.permission);
        return;
    }
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –≤–∫–ª—é—á–µ–Ω—ã –ª–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
    const notificationsEnabled = localStorage.getItem('notifications_enabled');
    if (notificationsEnabled !== 'true' && notificationsEnabled !== null) {
        console.log("[Notification] Notifications disabled in app settings");
        return;
    }
    
    // –ï—Å–ª–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞, –Ω–æ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ –µ—Å—Ç—å - –≤–∫–ª—é—á–∞–µ–º –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
    if (notificationsEnabled === null) {
        localStorage.setItem('notifications_enabled', 'true');
    }
    
    console.log("[Notification] Showing notification:", title, message);
    
    const notificationOptions = {
        body: message,
        icon: "https://cdn.jsdelivr.net/npm/emoji-datasource-apple@7.0.2/img/apple/64/1f604.png",
        badge: "https://cdn.jsdelivr.net/npm/emoji-datasource-apple@7.0.2/img/apple/64/1f604.png",
        tag: 'twin-message-' + Date.now(),
        requireInteraction: false,
        silent: false,
        renotify: true
    };
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
    try {
        const notification = new Notification(title, notificationOptions);
        console.log("[Notification] Notification created successfully");
        
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –ø–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—é
        notification.onclick = function() {
            window.focus();
            notification.close();
        };
        
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—à–∏–±–æ–∫
        notification.onerror = function(err) {
            console.log("[Notification] Error showing notification:", err);
        };
        
        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–∫—Ä—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ 8 —Å–µ–∫—É–Ω–¥
        setTimeout(() => {
            notification.close();
        }, 8000);
        
        // –í–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏–º –∑–≤—É–∫ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
        playNotificationSound();
    } catch (error) {
        console.log('[Notification] Error creating notification:', error);
    }
}

// Debug function to test notifications manually
function debugNotification() {
    console.log('[Debug] Testing notification system...');
    console.log('[Debug] Notification.permission:', Notification.permission);
    console.log('[Debug] notifications_enabled:', localStorage.getItem('notifications_enabled'));
    console.log('[Debug] document.hidden:', document.hidden);
    console.log('[Debug] currentUser:', currentUser);
    console.log('[Debug] currentChat:', currentChat);
    
    // Force show a test notification
    showBrowserNotification('Test Notification', 'This is a forced test notification');
}

// Make it available globally for debugging
window.debugNotification = debugNotification;

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è –∑–≤—É–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
function playNotificationSound() {
    try {
        // –°–æ–∑–¥–∞–µ–º –∞—É–¥–∏–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        
        // –°–æ–∑–¥–∞–µ–º –ø—Ä–æ—Å—Ç–æ–π –∑–≤—É–∫
        const oscillator = audioContext.createOscillator();
        const gainNode = audioContext.createGain();
        
        oscillator.connect(gainNode);
        gainNode.connect(audioContext.destination);
        
        oscillator.type = 'sine';
        oscillator.frequency.setValueAtTime(800, audioContext.currentTime);
        gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
        
        oscillator.start();
        oscillator.stop(audioContext.currentTime + 0.1);
        
        // –í–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏–º –∑–≤—É–∫
        audioContext.resume();
    } catch (error) {
        console.log('–ó–≤—É–∫ –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è');
    }
}
        
        function debounce(func, wait) {
            let timeout;
            return function() {
                const context = this;
                const args = arguments;
                clearTimeout(timeout);
                timeout = setTimeout(() => {
                    func.apply(context, args);
                }, wait);
            };
        }
        
        // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –∫–∞–Ω–∞–ª–∞–º–∏
        async function openCreateChannel() {
            channelNameInput.value = '';
            channelDescriptionInput.value = '';
            
            createChannelModal.classList.add('active');
            settingsMenu.classList.remove('active');
        }
        
        function closeCreateChannel() {
            createChannelModal.classList.remove('active');
        }
        
        async function createChannel() {
            const channelName = channelNameInput.value.trim();
            const channelDescription = channelDescriptionInput.value.trim();
            
            if (!channelName) {
                showNotification('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–∞–Ω–∞–ª–∞');
                return;
            }
            
            try {
                const channelId = 'channel_' + Date.now();
                
                await database.ref('channels/' + channelId).set({
                    name: channelName,
                    description: channelDescription,
                    creator: currentUser,
                    subscribers: [currentUser],
                    createdAt: Date.now()
                });
                
                showNotification('–ö–∞–Ω–∞–ª —Å–æ–∑–¥–∞–Ω —É—Å–ø–µ—à–Ω–æ');
                closeCreateChannel();
                
                loadChannels();
                
                openChannelChat(channelId, channelName);
                
                subscribedChannels.push(channelId);
                await updateSubscribedChannels();
            } catch (error) {
                showNotification('–û—à–∏–±–∫–∞: ' + error.message);
            }
        }
        
        async function loadChannels() {
            try {
                const snapshot = await database.ref('channels').once('value');
                const channelsData = snapshot.val();
                channels = [];
                
                if (channelsData) {
                    Object.keys(channelsData).forEach(channelId => {
                        const channel = channelsData[channelId];
                        channels.push({
                            id: channelId,
                            name: channel.name,
                            description: channel.description,
                            creator: channel.creator,
                            subscribers: channel.subscribers || [],
                            createdAt: channel.createdAt,
                            icons: channel.icons || []
                        });
                    });
                }
                
                displayChannels();
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–∞–Ω–∞–ª–æ–≤:', error);
            }
        }
        
        function displayChannels() {
            searchResults.innerHTML = '';
            
            if (channels.length === 0) {
                searchResults.innerHTML = '<div class="user-item">–ö–∞–Ω–∞–ª—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</div>';
                return;
            }
            
            channels.forEach(channel => {
                const channelItem = document.createElement('div');
                channelItem.className = 'channel-item';
                
                const isSubscribed = subscribedChannels.includes(channel.id);
                const iconHtml = getChannelIconHtml(channel);
                
                channelItem.innerHTML = `
                    <div class="channel-icon">${iconHtml}</div>
                    <div class="channel-info">
                        <h3>${escapeHtml(channel.name)}</h3>
                        <p>${escapeHtml(channel.description || '–ù–µ—Ç –æ–ø–∏—Å–∞–Ω–∏—è')}</p>
                        <div class="channel-subscribers">
                            <span>üë§ ${channel.subscribers ? channel.subscribers.length : 0}</span>
                        </div>
                    </div>
                    <button class="subscribe-btn ${isSubscribed ? 'subscribed' : ''}" data-channel-id="${channel.id}">
                        ${isSubscribed ? '–û—Ç–ø–∏—Å–∞—Ç—å—Å—è' : '–ü–æ–¥–ø–∏—Å–∞—Ç—å—Å—è'}
                    </button>
                `;
                
                const subscribeBtn = channelItem.querySelector('.subscribe-btn');
                subscribeBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    toggleSubscribe(channel.id);
                });
                
                channelItem.addEventListener('click', () => {
                    if (isSubscribed) {
                        openChannelChat(channel.id, channel.name);
                    } else {
                        showNotification('–ü–æ–¥–ø–∏—à–∏—Ç–µ—Å—å –Ω–∞ –∫–∞–Ω–∞–ª, —á—Ç–æ–±—ã –ø—Ä–æ—Å–º–∞—Ç—Ä–∏–≤–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è');
                    }
                });
                
                searchResults.appendChild(channelItem);
            });
        }
        
        async function toggleSubscribe(channelId) {
    try {
        const channel = channels.find(c => c.id === channelId);
        const isSubscribed = subscribedChannels.includes(channelId);
        
        if (isSubscribed) {
            subscribedChannels = subscribedChannels.filter(id => id !== channelId);
            showNotification('–í—ã –æ—Ç–ø–∏—Å–∞–ª–∏—Å—å –æ—Ç –∫–∞–Ω–∞–ª–∞');
        } else {
            subscribedChannels.push(channelId);
            showNotification('–í—ã –ø–æ–¥–ø–∏—Å–∞–ª–∏—Å—å –Ω–∞ –∫–∞–Ω–∞–ª');
            
            // –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ —Å–æ–∑–¥–∞—Ç–µ–ª—é –∫–∞–Ω–∞–ª–∞ –æ –Ω–æ–≤–æ–º –ø–æ–¥–ø–∏—Å—á–∏–∫–µ
            if (channel && channel.creator !== currentUser) {
                // –°–æ–∑–¥–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤ Firebase –¥–ª—è —Å–æ–∑–¥–∞—Ç–µ–ª—è –∫–∞–Ω–∞–ª–∞
                try {
                    const creatorNotificationsRef = database.ref('users/' + encodeURIComponent(channel.creator) + '/notifications');
                    await creatorNotificationsRef.push({
                        type: 'new_subscriber',
                        from: currentUser,
                        channelName: channel.name,
                        channelId: channelId,
                        timestamp: Date.now(),
                        read: false
                    });
                    
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –±—Ä–∞—É–∑–µ—Ä–Ω–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ —Å–æ–∑–¥–∞—Ç–µ–ª—é, –µ—Å–ª–∏ –æ–Ω –æ–Ω–ª–∞–π–Ω
                    showBrowserNotification(
                        '–ù–æ–≤—ã–π –ø–æ–¥–ø–∏—Å—á–∏–∫',
                        `${currentUser} –ø–æ–¥–ø–∏—Å–∞–ª—Å—è –Ω–∞ –≤–∞—à –∫–∞–Ω–∞–ª "${channel.name}"`
                    );
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è —Å–æ–∑–¥–∞—Ç–µ–ª—é:', error);
                }
            }
        }
        
        await updateSubscribedChannels();
        
        if (channel) {
            if (isSubscribed) {
                channel.subscribers = channel.subscribers.filter(sub => sub !== currentUser);
            } else {
                if (!channel.subscribers) {
                    channel.subscribers = [];
                }
                channel.subscribers.push(currentUser);
            }
            
            await database.ref('channels/' + channelId).update({
                subscribers: channel.subscribers
            });
        }
        
        if (activeTab === 'channels') {
            loadChannels();
        } else if (activeTab === 'chats') {
            loadRecentChats();
        }
    } catch (error) {
        showNotification('–û—à–∏–±–∫–∞: ' + error.message);
    }
}

        
        async function updateSubscribedChannels() {
            try {
                await database.ref('users/' + encodeURIComponent(currentUser)).update({
                    subscribedChannels: subscribedChannels
                });
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø–æ–¥–ø–∏—Å–∞–Ω–Ω—ã—Ö –∫–∞–Ω–∞–ª–æ–≤:', error);
            }
        }
        
        async function loadSubscribedChannels() {
            try {
                const snapshot = await database.ref('users/' + encodeURIComponent(currentUser)).once('value');
                const userData = snapshot.val();
                if (userData && userData.subscribedChannels) {
                    subscribedChannels = userData.subscribedChannels;
                } else {
                    subscribedChannels = [];
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–¥–ø–∏—Å–∞–Ω–Ω—ã—Ö –∫–∞–Ω–∞–ª–æ–≤:', error);
                subscribedChannels = [];
            }
        }
        
        async function unsubscribeFromChannel(channelId) {
            subscribedChannels = subscribedChannels.filter(id => id !== channelId);
            await updateSubscribedChannels();
            
            const channel = channels.find(c => c.id === channelId);
            if (channel) {
                channel.subscribers = channel.subscribers.filter(sub => sub !== currentUser);
                
                await database.ref('channels/' + channelId).update({
                    subscribers: channel.subscribers
                });
            }
        }
        
        function openChannelChat(channelId, channelName) {
            if (window.innerWidth <= 768) {
                sidebar.classList.remove('active');
                mobileTitle.textContent = channelName;
            }
            
            if (currentChat && messageListeners[currentChat]) {
                clearInterval(messageListeners[currentChat]);
            }
            
            currentChat = channelId;
            currentChatType = 'channel';
            currentChannel = channels.find(c => c.id === channelId);
            currentGroup = null;
            emptyState.style.display = 'none';
            chatHeader.style.display = 'flex';
            chatMessages.style.display = 'block';
            
            if (currentChannel && currentChannel.creator === currentUser) {
                messageInputContainer.style.display = 'flex';
            } else {
                messageInputContainer.style.display = 'none';
            }
            
            // Get channel icon for header
            const iconHtml = currentChannel ? getChannelIconHtml(currentChannel) : 'üì¢';
            
            chatUserEmoji.textContent = '';
            chatUserName.querySelector('span:last-child').textContent = channelName;
            
            // Check if icon is iframe or emoji
            if (currentChannel && currentChannel.icons && currentChannel.icons.length > 0) {
                chatAvatar.innerHTML = iconHtml;
            } else {
                chatAvatar.textContent = 'üì¢';
            }
            
            blockUserBtn.style.display = 'none';
            groupSettingsBtn.style.display = 'none';
            
            // –°–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –æ—á–∏—Å—Ç–∫–∏ –∏—Å—Ç–æ—Ä–∏–∏ AI
            const clearHistoryBtn = document.getElementById('clear-history-btn');
            if (clearHistoryBtn) clearHistoryBtn.style.display = 'none';
            
            if (currentChannel && currentChannel.creator === currentUser) {
                channelSettingsBtn.style.display = 'block';
            } else {
                channelSettingsBtn.style.display = 'none';
            }
            
            adjustMessageInput();
            
            loadMessages();
            
            messageListeners[channelId] = setInterval(() => {
                loadMessages();
            }, 3000);
        }
        
        async function openChannelSettings() {
            if (!currentChannel) return;
            
            editChannelNameInput.value = currentChannel.name;
            editChannelDescriptionInput.value = currentChannel.description || '';
            
            // Show/hide manage icons button based on whether user is the creator
            if (currentChannel.creator === currentUser) {
                manageChannelIconsBtn.style.display = 'block';
            } else {
                manageChannelIconsBtn.style.display = 'none';
            }
            
            channelSettingsModal.classList.add('active');
        }
        
        function closeChannelSettings() {
            channelSettingsModal.classList.remove('active');
        }
        
        async function saveChannelSettings() {
            if (!currentChannel) return;
            
            const newName = editChannelNameInput.value.trim();
            const newDescription = editChannelDescriptionInput.value.trim();
            
            if (!newName) {
                showNotification('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–∞–Ω–∞–ª–∞');
                return;
            }
            
            try {
                await database.ref('channels/' + currentChannel.id).update({
                    name: newName,
                    description: newDescription
                });
                
                currentChannel.name = newName;
                currentChannel.description = newDescription;
                
                chatUserName.querySelector('span:last-child').textContent = newName;
                
                showNotification('–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∫–∞–Ω–∞–ª–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã');
                closeChannelSettings();
                
                loadChannels();
            } catch (error) {
                showNotification('–û—à–∏–±–∫–∞: ' + error.message);
            }
        }
        
        async function unsubscribeChannel() {
            if (!currentChannel) return;
            
            if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –æ—Ç–ø–∏—Å–∞—Ç—å—Å—è –æ—Ç —ç—Ç–æ–≥–æ –∫–∞–Ω–∞–ª–∞?')) {
                try {
                    await unsubscribeFromChannel(currentChannel.id);
                    
                    showNotification('–í—ã –æ—Ç–ø–∏—Å–∞–ª–∏—Å—å –æ—Ç –∫–∞–Ω–∞–ª–∞');
                    closeChannelSettings();
                    closeChat();
                    
                    loadChannels();
                } catch (error) {
                    showNotification('–û—à–∏–±–∫–∞: ' + error.message);
                }
            }
        }
        
        // Functions for channel icon management
        async function openChannelIconsModal() {
            if (!currentChannel || currentChannel.creator !== currentUser) {
                showNotification('–¢–æ–ª—å–∫–æ —Å–æ–∑–¥–∞—Ç–µ–ª—å –∫–∞–Ω–∞–ª–∞ –º–æ–∂–µ—Ç —É–ø—Ä–∞–≤–ª—è—Ç—å –∏–∫–æ–Ω–∫–∞–º–∏');
                return;
            }
            
            closeChannelSettings();
            await loadChannelIcons();
            channelIconsModal.classList.add('active');
        }
        
        function closeChannelIconsModal() {
            channelIconsModal.classList.remove('active');
            channelIconUrlInput.value = '';
            updateChannelIconPreview();
        }
        
        function updateChannelIconPreview() {
            const url = channelIconUrlInput.value.trim();
            if (url) {
                channelIconPreview.innerHTML = `<iframe src="${escapeHtml(url)}" sandbox="allow-scripts"></iframe>`;
            } else {
                channelIconPreview.innerHTML = '<span>üì¢</span>';
            }
        }
        
        async function loadChannelIcons() {
            if (!currentChannel) return;
            
            try {
                const snapshot = await database.ref('channels/' + currentChannel.id + '/icons').once('value');
                const icons = snapshot.val();
                
                displayChannelIcons(icons || []);
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∫–æ–Ω–æ–∫ –∫–∞–Ω–∞–ª–∞:', error);
                channelIconsList.innerHTML = '<div style="text-align: center; color: var(--text-light); padding: 10px;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∫–æ–Ω–æ–∫</div>';
            }
        }
        
        function displayChannelIcons(icons) {
            channelIconsList.innerHTML = '';
            
            if (!icons || icons.length === 0) {
                channelIconsList.innerHTML = '<div style="text-align: center; color: var(--text-light); padding: 10px;">–ù–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω–Ω—ã—Ö –∏–∫–æ–Ω–æ–∫</div>';
                return;
            }
            
            icons.forEach((iconUrl, index) => {
                const iconItem = document.createElement('div');
                iconItem.className = 'channel-icon-item';
                iconItem.innerHTML = `
                    <div class="channel-icon-display">
                        <iframe src="${escapeHtml(iconUrl)}" sandbox="allow-scripts"></iframe>
                    </div>
                    <div class="channel-icon-url">${escapeHtml(iconUrl)}</div>
                    <button class="delete-icon-btn" data-icon-index="${index}">–£–¥–∞–ª–∏—Ç—å</button>
                `;
                
                const deleteBtn = iconItem.querySelector('.delete-icon-btn');
                deleteBtn.addEventListener('click', () => deleteChannelIcon(index));
                
                channelIconsList.appendChild(iconItem);
            });
        }
        
        async function addChannelIcon() {
            if (!currentChannel || currentChannel.creator !== currentUser) {
                showNotification('–¢–æ–ª—å–∫–æ —Å–æ–∑–¥–∞—Ç–µ–ª—å –∫–∞–Ω–∞–ª–∞ –º–æ–∂–µ—Ç –¥–æ–±–∞–≤–ª—è—Ç—å –∏–∫–æ–Ω–∫–∏');
                return;
            }
            
            const iconUrl = channelIconUrlInput.value.trim();
            
            if (!iconUrl) {
                showNotification('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ URL –∏–∫–æ–Ω–∫–∏');
                return;
            }
            
            // Basic URL validation
            if (!iconUrl.startsWith('http://') && !iconUrl.startsWith('https://')) {
                showNotification('URL –¥–æ–ª–∂–µ–Ω –Ω–∞—á–∏–Ω–∞—Ç—å—Å—è —Å http:// –∏–ª–∏ https://');
                return;
            }
            
            try {
                const snapshot = await database.ref('channels/' + currentChannel.id + '/icons').once('value');
                const currentIcons = snapshot.val() || [];
                
                // Check if icon already exists
                if (currentIcons.includes(iconUrl)) {
                    showNotification('–≠—Ç–∞ –∏–∫–æ–Ω–∫–∞ —É–∂–µ –¥–æ–±–∞–≤–ª–µ–Ω–∞');
                    return;
                }
                
                currentIcons.push(iconUrl);
                
                await database.ref('channels/' + currentChannel.id).update({
                    icons: currentIcons
                });
                
                currentChannel.icons = currentIcons;
                
                showNotification('–ò–∫–æ–Ω–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ');
                channelIconUrlInput.value = '';
                updateChannelIconPreview();
                await loadChannelIcons();
                
                // Refresh channel display
                loadChannels();
                if (activeTab === 'chats') {
                    loadRecentChats();
                }
            } catch (error) {
                showNotification('–û—à–∏–±–∫–∞: ' + error.message);
            }
        }
        
        async function deleteChannelIcon(index) {
            if (!currentChannel || currentChannel.creator !== currentUser) {
                showNotification('–¢–æ–ª—å–∫–æ —Å–æ–∑–¥–∞—Ç–µ–ª—å –∫–∞–Ω–∞–ª–∞ –º–æ–∂–µ—Ç —É–¥–∞–ª—è—Ç—å –∏–∫–æ–Ω–∫–∏');
                return;
            }
            
            if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç—É –∏–∫–æ–Ω–∫—É?')) {
                return;
            }
            
            try {
                const snapshot = await database.ref('channels/' + currentChannel.id + '/icons').once('value');
                const currentIcons = snapshot.val() || [];
                
                if (index < 0 || index >= currentIcons.length) {
                    showNotification('–ò–∫–æ–Ω–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞');
                    return;
                }
                
                currentIcons.splice(index, 1);
                
                await database.ref('channels/' + currentChannel.id).update({
                    icons: currentIcons
                });
                
                currentChannel.icons = currentIcons;
                
                showNotification('–ò–∫–æ–Ω–∫–∞ —É–¥–∞–ª–µ–Ω–∞');
                await loadChannelIcons();
                
                // Refresh channel display
                loadChannels();
                if (activeTab === 'chats') {
                    loadRecentChats();
                }
            } catch (error) {
                showNotification('–û—à–∏–±–∫–∞: ' + error.message);
            }
        }
        
        // Helper function to get channel icon HTML
        function getChannelIconHtml(channel) {
            if (channel.icons && channel.icons.length > 0) {
                // Use the first icon (most recent)
                const iconUrl = channel.icons[channel.icons.length - 1];
                return `<iframe src="${escapeHtml(iconUrl)}" sandbox="allow-scripts"></iframe>`;
            }
            // Default icon
            return 'üì¢';
        }
        
        async function loadBlockedUsers() {
            try {
                const snapshot = await database.ref('users/' + encodeURIComponent(currentUser)).once('value');
                const userData = snapshot.val();
                if (userData && userData.blockedUsers) {
                    blockedUsers = userData.blockedUsers;
                } else {
                    blockedUsers = [];
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:', error);
                blockedUsers = [];
            }
        }
        
        function displayBlockedUsers() {
            blockedList.innerHTML = '';
            
            if (blockedUsers.length === 0) {
                blockedList.innerHTML = '<div>–ù–µ—Ç –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</div>';
                return;
            }
            
            blockedUsers.forEach(username => {
                const blockedItem = document.createElement('div');
                blockedItem.className = 'blocked-item';
                blockedItem.innerHTML = `
                    <span>${escapeHtml(username)}</span>
                    <button class="unblock-btn" data-username="${username}">–†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å</button>
                `;
                
                blockedList.appendChild(blockedItem);
            });
            
            document.querySelectorAll('.unblock-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const username = btn.dataset.username;
                    unblockUser(username);
                });
            });
        }
        
        async function unblockUser(username) {
            try {
                blockedUsers = blockedUsers.filter(u => u !== username);
                
                await database.ref('users/' + encodeURIComponent(currentUser)).update({
                    blockedUsers: blockedUsers
                });
                
                displayBlockedUsers();
                showNotification(`–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ${username} —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω`);
                
                if (activeTab === 'users') {
                    loadUsers();
                }
            } catch (error) {
                showNotification('–û—à–∏–±–∫–∞: ' + error.message);
            }
        }
        
        async function toggleBlockUser() {
            if (!currentChat || currentChatType !== 'user') {
                showNotification('–ù–µ–ª—å–∑—è –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –≥—Ä—É–ø–ø—É –∏–ª–∏ –∫–∞–Ω–∞–ª');
                return;
            }
            
            const isBlocked = blockedUsers.includes(currentChat);
            
            if (isBlocked) {
                await unblockUser(currentChat);
                blockUserBtn.innerHTML = 'üö´';
                blockUserBtn.title = '–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è';
            } else {
                if (confirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ${currentChat}?`)) {
                    try {
                        blockedUsers.push(currentChat);
                        
                        await database.ref('users/' + encodeURIComponent(currentUser)).update({
                            blockedUsers: blockedUsers
                        });
                        
                        showNotification(`–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ${currentChat} –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω`);
                        blockUserBtn.innerHTML = 'üîì';
                        blockUserBtn.title = '–†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è';
                        
                        if (activeTab === 'users') {
                            loadUsers();
                        }
                    } catch (error) {
                        showNotification('–û—à–∏–±–∫–∞: ' + error.message);
                    }
                }
            }
        }
        
        async function openCreateGroup() {
            groupNameInput.value = '';
            participantsList.innerHTML = '';
            
            try {
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏–∑ recentChats
                if (!currentUserData || !currentUserData.recentChats || currentUserData.recentChats.length === 0) {
                    participantsList.innerHTML = '<div style="padding: 10px; color: var(--text-light);">–°–Ω–∞—á–∞–ª–∞ –¥–æ–±–∞–≤—å—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —á–µ—Ä–µ–∑ –ø–æ–∏—Å–∫ –≤–æ –≤–∫–ª–∞–¥–∫–µ "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏"</div>';
                    createGroupModal.classList.add('active');
                    settingsMenu.classList.remove('active');
                    return;
                }
                
                for (const chat of currentUserData.recentChats) {
                    if (chat.username && chat.username !== currentUser) {
                        const participantItem = document.createElement('div');
                        participantItem.className = 'participant-item';
                        participantItem.innerHTML = `
                            <input type="checkbox" class="participant-checkbox" id="user-${chat.username}" value="${chat.username}">
                            <label for="user-${chat.username}">${escapeHtml(chat.name || chat.username)} ${chat.emoji || 'üòä'}</label>
                        `;
                        
                        participantsList.appendChild(participantItem);
                    }
                }
                
                createGroupModal.classList.add('active');
                settingsMenu.classList.remove('active');
            } catch (error) {
                showNotification('–û—à–∏–±–∫–∞: ' + error.message);
            }
        }
        
        function closeCreateGroup() {
            createGroupModal.classList.remove('active');
        }
        
        async function createGroup() {
            const groupName = groupNameInput.value.trim();
            if (!groupName) {
                showNotification('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –≥—Ä—É–ø–ø—ã');
                return;
            }
            
            const checkboxes = document.querySelectorAll('.participant-checkbox:checked');
            const participants = Array.from(checkboxes).map(cb => cb.value);
            
            if (participants.length < 1) {
                showNotification('–í—ã–±–µ—Ä–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω–æ–≥–æ —É—á–∞—Å—Ç–Ω–∏–∫–∞');
                return;
            }
            
            participants.push(currentUser);
            
            try {
                const groupId = 'group_' + Date.now();
                
                await database.ref('groups/' + groupId).set({
                    name: groupName,
                    admin: currentUser,
                    participants: participants,
                    createdAt: Date.now()
                });
                
                showNotification('–ì—Ä—É–ø–ø–∞ —Å–æ–∑–¥–∞–Ω–∞ —É—Å–ø–µ—à–Ω–æ');
                closeCreateGroup();
                
                loadGroups();
                
                openGroupChat(groupId, groupName);
                
                participants.forEach(async participant => {
                    if (participant !== currentUser) {
                        try {
                            await database.ref('users/' + encodeURIComponent(participant) + '/notifications').push({
                                type: 'group_invite',
                                groupId: groupId,
                                groupName: groupName,
                                from: currentUser,
                                timestamp: Date.now(),
                                read: false
                            });
                        } catch (error) {
                            console.error(`–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é ${participant}:`, error);
                        }
                    }
                });
            } catch (error) {
                showNotification('–û—à–∏–±–∫–∞: ' + error.message);
            }
        }
        
        async function loadGroups() {
            try {
                const snapshot = await database.ref('groups').once('value');
                const groupsData = snapshot.val();
                groups = [];
                
                if (groupsData) {
                    Object.keys(groupsData).forEach(groupId => {
                        const group = groupsData[groupId];
                        if (group.participants && group.participants.includes(currentUser)) {
                            groups.push({
                                id: groupId,
                                name: group.name,
                                admin: group.admin,
                                participants: group.participants,
                                createdAt: group.createdAt
                            });
                        }
                    });
                }
                
                if (activeTab === 'chats') {
                    loadRecentChats();
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≥—Ä—É–ø–ø:', error);
            }
        }
        
        function openGroupChat(groupId, groupName) {
            if (window.innerWidth <= 768) {
                sidebar.classList.remove('active');
                mobileTitle.textContent = groupName;
            }
            
            if (currentChat && messageListeners[currentChat]) {
                clearInterval(messageListeners[currentChat]);
            }
            
            currentChat = groupId;
            currentChatType = 'group';
            currentGroup = groups.find(g => g.id === groupId);
            emptyState.style.display = 'none';
            chatHeader.style.display = 'flex';
            chatMessages.style.display = 'block';
            messageInputContainer.style.display = 'flex';
            
            chatUserEmoji.textContent = 'üë•';
            chatUserName.querySelector('span:last-child').textContent = groupName;
            chatAvatar.textContent = 'üë•';
            
            blockUserBtn.style.display = 'none';
            
            // –°–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –æ—á–∏—Å—Ç–∫–∏ –∏—Å—Ç–æ—Ä–∏–∏ AI
            const clearHistoryBtn = document.getElementById('clear-history-btn');
            if (clearHistoryBtn) clearHistoryBtn.style.display = 'none';
            
            if (currentGroup && currentGroup.admin === currentUser) {
                groupSettingsBtn.style.display = 'block';
            } else {
                groupSettingsBtn.style.display = 'none';
            }
            
            channelSettingsBtn.style.display = 'none';
            
            adjustMessageInput();
            
            loadMessages();
            
            messageListeners[groupId] = setInterval(() => {
                loadMessages();
            }, 3000);
        }
        
        async function openGroupSettings() {
            if (!currentGroup) return;
            
            editGroupNameInput.value = currentGroup.name;
            editParticipantsList.innerHTML = '';
            
            try {
                // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –∏–∑ Firebase
                for (const participant of currentGroup.participants) {
                    if (participant !== currentUser) {
                        const snapshot = await database.ref('users/' + encodeURIComponent(participant)).once('value');
                        const user = snapshot.val();
                        
                        const participantItem = document.createElement('div');
                        participantItem.className = 'participant-item';
                        participantItem.innerHTML = `
                            <span>${escapeHtml(user ? (user.name || user.username) : participant)} ${user ? (user.emoji || 'üòä') : ''}</span>
                            ${currentGroup.admin === currentUser ? `<button class="remove-participant-btn" data-username="${participant}">–£–¥–∞–ª–∏—Ç—å</button>` : ''}
                        `;
                        
                        editParticipantsList.appendChild(participantItem);
                    }
                }
                
                document.querySelectorAll('.remove-participant-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const username = btn.dataset.username;
                        removeParticipant(username);
                    });
                });
                
                groupSettingsModal.classList.add('active');
            } catch (error) {
                showNotification('–û—à–∏–±–∫–∞: ' + error.message);
            }
        }
        
        async function removeParticipant(username) {
            if (!currentGroup || currentGroup.admin !== currentUser) return;
            
            if (confirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å ${username} –∏–∑ –≥—Ä—É–ø–ø—ã?`)) {
                try {
                    const updatedParticipants = currentGroup.participants.filter(p => p !== username);
                    
                    await database.ref('groups/' + currentGroup.id).update({
                        participants: updatedParticipants
                    });
                    
                    currentGroup.participants = updatedParticipants;
                    
                    showNotification(`–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ${username} —É–¥–∞–ª–µ–Ω –∏–∑ –≥—Ä—É–ø–ø—ã`);
                    
                    openGroupSettings();
                    
                    try {
                        await database.ref('users/' + encodeURIComponent(username) + '/notifications').push({
                            type: 'group_remove',
                            groupId: currentGroup.id,
                            groupName: currentGroup.name,
                            from: currentUser,
                            timestamp: Date.now(),
                            read: false
                        });
                    } catch (error) {
                        console.error(`–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é ${username}:`, error);
                    }
                } catch (error) {
                    showNotification('–û—à–∏–±–∫–∞: ' + error.message);
                }
            }
        }
        
        function closeGroupSettings() {
            groupSettingsModal.classList.remove('active');
        }
        
        async function saveGroupSettings() {
            if (!currentGroup) return;
            
            const newName = editGroupNameInput.value.trim();
            if (!newName) {
                showNotification('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –≥—Ä—É–ø–ø—ã');
                return;
            }
            
            try {
                await database.ref('groups/' + currentGroup.id).update({
                    name: newName
                });
                
                currentGroup.name = newName;
                
                chatUserName.querySelector('span:last-child').textContent = newName;
                
                showNotification('–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –≥—Ä—É–ø–ø—ã —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã');
                closeGroupSettings();
                
                loadGroups();
            } catch (error) {
                showNotification('–û—à–∏–±–∫–∞: ' + error.message);
            }
        }
        
        async function leaveGroup() {
            if (!currentGroup) return;
            
            if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –ø–æ–∫–∏–Ω—É—Ç—å —ç—Ç—É –≥—Ä—É–ø–ø—É?')) {
                try {
                    const updatedParticipants = currentGroup.participants.filter(p => p !== currentUser);
                    
                    await database.ref('groups/' + currentGroup.id).update({
                        participants: updatedParticipants
                    });
                    
                    showNotification('–í—ã –ø–æ–∫–∏–Ω—É–ª–∏ –≥—Ä—É–ø–ø—É');
                    closeGroupSettings();
                    closeChat();
                    
                    loadGroups();
                } catch (error) {
                    showNotification('–û—à–∏–±–∫–∞: ' + error.message);
                }
            }
        }
        
        async function deleteChat() {
            if (!currentChat) return;
            
            let confirmMessage = '';
            let group = null;
            let channel = null;
            
            if (currentChatType === 'group') {
                group = currentGroup || groups.find(g => g.id === currentChat);
                if (group && group.admin === currentUser) {
                    confirmMessage = '–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç—É –≥—Ä—É–ø–ø—É? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–æ–±—Ä–∞—Ç–∏–º–æ.';
                } else {
                    confirmMessage = '–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –ø–æ–∫–∏–Ω—É—Ç—å —ç—Ç—É –≥—Ä—É–ø–ø—É?';
                }
            } else if (currentChatType === 'channel') {
                channel = currentChannel || channels.find(c => c.id === currentChat);
                if (channel && channel.creator === currentUser) {
                    confirmMessage = '–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç –∫–∞–Ω–∞–ª? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–æ–±—Ä–∞—Ç–∏–º–æ.';
                } else {
                    confirmMessage = '–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –æ—Ç–ø–∏—Å–∞—Ç—å—Å—è –æ—Ç —ç—Ç–æ–≥–æ –∫–∞–Ω–∞–ª–∞?';
                }
            } else {
                confirmMessage = '–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç —á–∞—Ç? –í—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è –±—É–¥—É—Ç —É–¥–∞–ª–µ–Ω—ã.';
            }
            
            if (confirm(confirmMessage)) {
                try {
                    if (currentChatType === 'group') {
                        if (!group && currentChat) {
                            const groupSnapshot = await database.ref('groups/' + currentChat).once('value');
                            group = groupSnapshot.val();
                        }
                        
                        if (group && group.admin === currentUser) {
                            await database.ref('groups/' + currentChat).remove();
                            await database.ref('messages/' + currentChat).remove();
                            showNotification('–ì—Ä—É–ø–ø–∞ —É–¥–∞–ª–µ–Ω–∞');
                        } else if (group && group.participants) {
                            const updatedParticipants = group.participants.filter(p => p !== currentUser);
                            await database.ref('groups/' + currentChat).update({
                                participants: updatedParticipants
                            });
                            showNotification('–í—ã –ø–æ–∫–∏–Ω—É–ª–∏ –≥—Ä—É–ø–ø—É');
                        } else {
                            showNotification('–ì—Ä—É–ø–ø–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞');
                        }
                        
                        await loadGroups();
                    } else if (currentChatType === 'channel') {
                        if (!channel && currentChat) {
                            const channelSnapshot = await database.ref('channels/' + currentChat).once('value');
                            channel = channelSnapshot.val();
                        }
                        
                        if (channel && channel.creator === currentUser) {
                            await database.ref('channels/' + currentChat).remove();
                            await database.ref('messages/' + currentChat).remove();
                            showNotification('–ö–∞–Ω–∞–ª —É–¥–∞–ª–µ–Ω');
                        } else {
                            await unsubscribeFromChannel(currentChat);
                            showNotification('–í—ã –æ—Ç–ø–∏—Å–∞–ª–∏—Å—å –æ—Ç –∫–∞–Ω–∞–ª–∞');
                        }
                        
                        await loadChannels();
                    } else {
                        const chatId = getChatId(currentUser, currentChat);
                        await database.ref('messages/' + chatId).remove();
                        
                        // –£–¥–∞–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ recentChats
                        const userRef = database.ref('users/' + encodeURIComponent(currentUser));
                        const snapshot = await userRef.once('value');
                        const userData = snapshot.val();
                        
                        if (userData && userData.recentChats) {
                            const updatedRecentChats = userData.recentChats.filter(chat => chat.username !== currentChat);
                            await userRef.update({ recentChats: updatedRecentChats });
                            currentUserData.recentChats = updatedRecentChats;
                        }
                        
                        showNotification('–ß–∞—Ç —É–¥–∞–ª–µ–Ω');
                    }
                    
                    closeChat();
                    
                    if (activeTab === 'chats') {
                        await loadRecentChats();
                    }
                } catch (error) {
                    showNotification('–û—à–∏–±–∫–∞: ' + error.message);
                }
            }
        }
        
        // –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        // –ò—Å–ø–æ–ª—å–∑—É–µ–º –≥–ª–æ–±–∞–ª—å–Ω—É—é currentUserData, –æ–±—ä—è–≤–ª–µ–Ω–Ω—É—é –≤—ã—à–µ
        
        // –ü–æ–∫–∞–∑–∞—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –≤—Ö–æ–¥–∞/—Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
        async function requestUsername() {
            const modal = document.createElement('div');
            modal.id = 'auth-modal';
            modal.style.position = 'fixed';
            modal.style.top = '0';
            modal.style.left = '0';
            modal.style.right = '0';
            modal.style.bottom = '0';
            modal.style.backgroundColor = 'rgba(0,0,0,0.5)';
            modal.style.display = 'flex';
            modal.style.justifyContent = 'center';
            modal.style.alignItems = 'center';
            modal.style.zIndex = '1000';
            
            const modalContent = document.createElement('div');
            modalContent.style.backgroundColor = 'white';
            modalContent.style.padding = '20px';
            modalContent.style.borderRadius = '10px';
            modalContent.style.width = '90%';
            modalContent.style.maxWidth = '400px';
            modalContent.style.maxHeight = '90vh';
            modalContent.style.overflowY = 'auto';
            
            modalContent.innerHTML = `
                <h2 style="margin-bottom: 15px; text-align: center;">–í—Ö–æ–¥ / –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</h2>
                <div id="auth-tabs" style="display: flex; margin-bottom: 15px; border-bottom: 1px solid #ddd;">
                    <button id="login-tab" style="flex: 1; padding: 10px; border: none; background: #6c5ce7; color: white; cursor: pointer;">–í—Ö–æ–¥</button>
                    <button id="register-tab" style="flex: 1; padding: 10px; border: none; background: #f0f0f0; color: #333; cursor: pointer;">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</button>
                </div>
                <div id="login-form">
                    <input type="text" id="login-username" 
                           style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 5px; margin-bottom: 10px; font-size: 16px;"
                           placeholder="–Æ–∑–µ—Ä–Ω–µ–π–º" autocomplete="off">
                    <input type="password" id="login-password" 
                           style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 5px; margin-bottom: 15px; font-size: 16px;"
                           placeholder="–ü–∞—Ä–æ–ª—å">
                    <button id="submit-login" 
                            style="width: 100%; padding: 12px; background: #6c5ce7; color: white; border: none; border-radius: 5px; cursor: pointer;">
                        –í–æ–π—Ç–∏
                    </button>
                </div>
                <div id="register-form" style="display: none;">
                    <input type="text" id="reg-name" 
                           style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 5px; margin-bottom: 10px; font-size: 16px;"
                           placeholder="–ò–º—è" autocomplete="off">
                    <input type="text" id="reg-username" 
                           style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 5px; margin-bottom: 10px; font-size: 16px;"
                           placeholder="–Æ–∑–µ—Ä–Ω–µ–π–º (—É–Ω–∏–∫–∞–ª—å–Ω—ã–π)" autocomplete="off">
                    <input type="password" id="reg-password" 
                           style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 5px; margin-bottom: 15px; font-size: 16px;"
                           placeholder="–ü–∞—Ä–æ–ª—å">
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px;">–í—ã–±–µ—Ä–∏—Ç–µ —Å—Ç–∞—Ç—É—Å:</label>
                        <div style="display: flex; flex-wrap: wrap; gap: 10px;">
                            <span class="emoji-option" data-emoji="üòä" style="font-size: 1.5rem; cursor: pointer; padding: 5px; border-radius: 5px;">üòä</span>
                            <span class="emoji-option" data-emoji="üòé" style="font-size: 1.5rem; cursor: pointer; padding: 5px; border-radius: 5px;">üòé</span>
                            <span class="emoji-option" data-emoji="ü§î" style="font-size: 1.5rem; cursor: pointer; padding: 5px; border-radius: 5px;">ü§î</span>
                            <span class="emoji-option" data-emoji="üò¥" style="font-size: 1.5rem; cursor: pointer; padding: 5px; border-radius: 5px;">üò¥</span>
                            <span class="emoji-option" data-emoji="üò¢" style="font-size: 1.5rem; cursor: pointer; padding: 5px; border-radius: 5px;">üò¢</span>
                            <span class="emoji-option" data-emoji="üò°" style="font-size: 1.5rem; cursor: pointer; padding: 5px; border-radius: 5px;">üò°</span>
                            <span class="emoji-option" data-emoji="ü•≥" style="font-size: 1.5rem; cursor: pointer; padding: 5px; border-radius: 5px;">ü•≥</span>
                            <span class="emoji-option" data-emoji="üòç" style="font-size: 1.5rem; cursor: pointer; padding: 5px; border-radius: 5px;">üòç</span>
                        </div>
                    </div>
                    <button id="submit-register" 
                            style="width: 100%; padding: 12px; background: #2ecc71; color: white; border: none; border-radius: 5px; cursor: pointer;">
                        –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è
                    </button>
                </div>
            `;
            
            modal.appendChild(modalContent);
            document.body.appendChild(modal);
            
            const loginTab = document.getElementById('login-tab');
            const registerTab = document.getElementById('register-tab');
            const loginForm = document.getElementById('login-form');
            const registerForm = document.getElementById('register-form');
            
            loginTab.addEventListener('click', () => {
                loginForm.style.display = 'block';
                registerForm.style.display = 'none';
                loginTab.style.background = '#6c5ce7';
                loginTab.style.color = 'white';
                registerTab.style.background = '#f0f0f0';
                registerTab.style.color = '#333';
            });
            
            registerTab.addEventListener('click', () => {
                loginForm.style.display = 'none';
                registerForm.style.display = 'block';
                registerTab.style.background = '#6c5ce7';
                registerTab.style.color = 'white';
                loginTab.style.background = '#f0f0f0';
                loginTab.style.color = '#333';
            });
            
            // –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è
            const regName = document.getElementById('reg-name');
            const regUsername = document.getElementById('reg-username');
            const regPassword = document.getElementById('reg-password');
            const submitRegister = document.getElementById('submit-register');
            const emojiOptions = registerForm.querySelectorAll('.emoji-option');
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ emoji-–æ–ø—Ü–∏–∏ –Ω–∞–π–¥–µ–Ω—ã
            if (emojiOptions.length > 0) {
                emojiOptions[0].classList.add('selected');
                userEmoji = emojiOptions[0].dataset.emoji;
            } else {
                userEmoji = 'üòä'; // –ó–Ω–∞—á–µ–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
            }
            
            emojiOptions.forEach(opt => {
                opt.addEventListener('click', () => {
                    emojiOptions.forEach(o => o.classList.remove('selected'));
                    opt.classList.add('selected');
                    userEmoji = opt.dataset.emoji;
                });
            });
            
            submitRegister.addEventListener('click', async () => {
                const name = regName.value.trim();
                const username = regUsername.value.trim().toLowerCase();
                const password = regPassword.value.trim();
                
                if (!name || !username || !password) {
                    showNotification('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è');
                    return;
                }
                
                if (username.length < 3) {
                    showNotification('–Æ–∑–µ—Ä–Ω–µ–π–º –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –Ω–µ –º–µ–Ω–µ–µ 3 —Å–∏–º–≤–æ–ª–æ–≤');
                    return;
                }
                
                if (password.length < 4) {
                    showNotification('–ü–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –Ω–µ –º–µ–Ω–µ–µ 4 —Å–∏–º–≤–æ–ª–æ–≤');
                    return;
                }
                
                try {
                    const userRef = database.ref('users/' + encodeURIComponent(username));
                    const snapshot = await userRef.once('value');
                    
                    if (snapshot.exists()) {
                        showNotification('–≠—Ç–æ—Ç —é–∑–µ—Ä–Ω–µ–π–º —É–∂–µ –∑–∞–Ω—è—Ç');
                        return;
                    }
                    
                    currentUser = username;
                    currentUserData = {
                        name: name,
                        username: username,
                        password: password,
                        emoji: userEmoji,
                        online: true,
                        lastSeen: Date.now(),
                        blockedUsers: [],
                        subscribedChannels: [],
                        recentChats: []
                    };
                    
                    await userRef.set(currentUserData);
                    localStorage.setItem('messenger_user', JSON.stringify({username: username, password: password}));
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º UI —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è —ç–ª–µ–º–µ–Ω—Ç–æ–≤
                    if (currentUserEl) {
                        const nameSpan = currentUserEl.querySelector('span:last-child');
                        if (nameSpan) nameSpan.textContent = name;
                    }
                    if (userEmojiEl) {
                        userEmojiEl.textContent = userEmoji;
                    }
                    
                    await updateUserStatus(true);
                    
                    loadRecentChats();
                    loadGroups();
                    loadChannels();
                    
                    document.body.removeChild(modal);
                    
                    subscribeToPushNotifications();
                    startBackgroundChecks();
                    trackUserStatus();
                    
                    showNotification('–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞!');
                } catch (error) {
                    showNotification('–û—à–∏–±–∫–∞: ' + error.message);
                }
            });
            
            // –í—Ö–æ–¥
            const loginUsername = document.getElementById('login-username');
            const loginPassword = document.getElementById('login-password');
            const submitLogin = document.getElementById('submit-login');
            
            submitLogin.addEventListener('click', async () => {
                const username = loginUsername.value.trim().toLowerCase();
                const password = loginPassword.value.trim();
                
                if (!username || !password) {
                    showNotification('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ —é–∑–µ—Ä–Ω–µ–π–º –∏ –ø–∞—Ä–æ–ª—å');
                    return;
                }
                
                try {
                    const userRef = database.ref('users/' + encodeURIComponent(username));
                    const snapshot = await userRef.once('value');
                    
                    if (!snapshot.exists()) {
                        showNotification('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω');
                        return;
                    }
                    
                    const userData = snapshot.val();
                    
                    if (userData.password !== password) {
                        showNotification('–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å');
                        return;
                    }
                    
                    currentUser = username;
                    currentUserData = userData;
                    userEmoji = userData.emoji || 'üòä';
                    blockedUsers = userData.blockedUsers || [];
                    subscribedChannels = userData.subscribedChannels || [];
                    
                    localStorage.setItem('messenger_user', JSON.stringify({username: username, password: password}));
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º UI —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è —ç–ª–µ–º–µ–Ω—Ç–æ–≤
                    if (currentUserEl) {
                        const nameSpan = currentUserEl.querySelector('span:last-child');
                        if (nameSpan) nameSpan.textContent = userData.name || username;
                    }
                    if (userEmojiEl) {
                        userEmojiEl.textContent = userEmoji;
                    }
                    
                    await updateUserStatus(true);
                    
                    loadRecentChats();
                    loadGroups();
                    loadChannels();
                    
                    document.body.removeChild(modal);
                    
                    subscribeToPushNotifications();
                    startBackgroundChecks();
                    trackUserStatus();
                    
                    showNotification('–í—Ö–æ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω —É—Å–ø–µ—à–Ω–æ!');
                } catch (error) {
                    showNotification('–û—à–∏–±–∫–∞: ' + error.message);
                }
            });
            
            // Enter key support
            loginPassword.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') submitLogin.click();
            });
            regPassword.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') submitRegister.click();
            });
            
            loginUsername.focus();
        }
        
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–∫—Ä—ã—Ç–∏—è –≤–∫–ª–∞–¥–∫–∏/–ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
        window.addEventListener('beforeunload', () => {
            if (currentUser) {
                database.ref('users/' + encodeURIComponent(currentUser)).update({
                    online: false,
                    lastSeen: Date.now()
                });
            }
        });
    </script>
</body>
</html>
